<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ“º Screen â€” DS Agent</title>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=Sora:wght@700;800&display=swap" rel="stylesheet">
    <style>
        :root{
            --p:#5b5ef4;--p2:#8b5cf6;--acc:#06d6a0;
            --warn:#f59e0b;--danger:#ef4444;
            --bg:#0f0f1a;--surface:#1a1a2e;--surface2:#232340;
            --text:#f0f0ff;--muted:#8890a4;--border:#2a2a4a;
        }
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:'DM Sans',sans-serif;background:var(--bg);min-height:100vh;color:var(--text);overflow-x:hidden}

        /* â”€â”€ PARTICLES BG â”€â”€ */
        .particles{position:fixed;inset:0;pointer-events:none;z-index:0;overflow:hidden}
        .particle{position:absolute;border-radius:50%;opacity:0.15;animation:float linear infinite}
        @keyframes float{0%{transform:translateY(100vh) rotate(0deg);opacity:0}10%{opacity:0.15}90%{opacity:0.1}100%{transform:translateY(-10vh) rotate(720deg);opacity:0}}

        /* â”€â”€ TOP NAV â”€â”€ */
        .topnav{position:sticky;top:0;z-index:100;display:flex;align-items:center;justify-content:space-between;padding:12px 20px;background:rgba(15,15,26,0.85);backdrop-filter:blur(12px);border-bottom:1px solid var(--border)}
        .logo{font-family:'Sora',sans-serif;font-size:18px;font-weight:800;background:linear-gradient(135deg,var(--p),var(--p2));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
        .nav-links{display:flex;gap:8px}
        .nav-links a{color:var(--muted);text-decoration:none;font-size:12px;font-weight:700;padding:5px 12px;border-radius:20px;border:1px solid var(--border);transition:0.2s}
        .nav-links a:hover{color:var(--text);border-color:var(--p)}
        .admin-badge{background:linear-gradient(135deg,var(--warn),#fb923c);color:white;padding:5px 12px;border-radius:20px;font-size:12px;font-weight:800;text-decoration:none;border:none}

        /* â”€â”€ TICKER â”€â”€ */
        .ticker-wrap{background:linear-gradient(90deg,var(--p),var(--p2));padding:8px 0;overflow:hidden;position:relative;z-index:10}
        .ticker-wrap::before,.ticker-wrap::after{content:'';position:absolute;top:0;bottom:0;width:60px;z-index:1}
        .ticker-wrap::before{left:0;background:linear-gradient(90deg,var(--p),transparent)}
        .ticker-wrap::after{right:0;background:linear-gradient(-90deg,var(--p2),transparent)}
        .ticker-inner{display:flex;white-space:nowrap;animation:ticker 30s linear infinite}
        .ticker-inner:hover{animation-play-state:paused}
        .ticker-item{display:inline-flex;align-items:center;gap:6px;padding:0 32px;font-size:13px;font-weight:700;color:white}
        .ticker-sep{opacity:0.5;margin:0 8px}
        @keyframes ticker{0%{transform:translateX(0)}100%{transform:translateX(-50%)}}

        /* â”€â”€ MAIN LAYOUT â”€â”€ */
        .page{display:flex;flex-direction:column;gap:16px;padding:16px;max-width:700px;margin:0 auto;position:relative;z-index:1}

        /* â”€â”€ POSTS SECTION â”€â”€ */
        .section-label{font-size:11px;font-weight:800;color:var(--muted);text-transform:uppercase;letter-spacing:1.5px;margin-bottom:10px;display:flex;align-items:center;gap:8px}
        .section-label::after{content:'';flex:1;height:1px;background:var(--border)}

        /* Post Carousel */
        .posts-carousel{position:relative;overflow:hidden;border-radius:20px}
        .post-slide{display:none;position:relative;animation:slideIn 0.5s cubic-bezier(0.34,1.2,0.64,1)}
        .post-slide.active{display:block}
        @keyframes slideIn{0%{opacity:0;transform:translateX(40px) scale(0.97)}100%{opacity:1;transform:translateX(0) scale(1)}}

        /* TEXT POST */
        .post-text{background:var(--surface);border-radius:20px;padding:24px;border:1px solid var(--border);position:relative;overflow:hidden;min-height:200px;display:flex;flex-direction:column;justify-content:space-between}
        .post-text::before{content:'';position:absolute;top:-40px;right:-40px;width:150px;height:150px;border-radius:50%;background:linear-gradient(135deg,var(--p),var(--p2));opacity:0.12}
        .post-text::after{content:'';position:absolute;bottom:-30px;left:-30px;width:100px;height:100px;border-radius:50%;background:linear-gradient(135deg,var(--acc),#34d399);opacity:0.1}
        .post-title{font-family:'Sora',sans-serif;font-size:20px;font-weight:800;line-height:1.3;background:linear-gradient(135deg,#fff,#c4b5fd);-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin-bottom:10px}
        .post-content{font-size:14px;color:var(--muted);line-height:1.7;flex:1}

        /* IMAGE POST */
        .post-image-wrap{position:relative;border-radius:20px;overflow:hidden;min-height:220px;border:1px solid var(--border)}
        .post-image-wrap img{width:100%;height:280px;object-fit:cover;display:block}
        .post-image-overlay{position:absolute;bottom:0;left:0;right:0;background:linear-gradient(transparent,rgba(0,0,0,0.85));padding:20px 18px 16px}
        .post-image-title{font-family:'Sora',sans-serif;font-size:18px;font-weight:800;color:white;margin-bottom:6px}

        /* Affiliate button */
        .aff-btn{display:inline-flex;align-items:center;gap:6px;padding:10px 20px;background:linear-gradient(135deg,var(--p),var(--p2));color:white;border-radius:12px;text-decoration:none;font-size:13px;font-weight:800;margin-top:12px;transition:0.2s;border:none;cursor:pointer;font-family:'DM Sans',sans-serif}
        .aff-btn:hover{opacity:0.9;transform:translateY(-1px);box-shadow:0 6px 20px rgba(91,94,244,0.4)}

        /* Dots nav */
        .post-dots{display:flex;gap:6px;justify-content:center;margin-top:10px}
        .dot{width:7px;height:7px;border-radius:50%;background:var(--border);cursor:pointer;transition:0.3s}
        .dot.active{background:var(--p);width:20px;border-radius:4px}

        /* Auto-play progress bar */
        .post-progress{height:2px;background:var(--border);border-radius:2px;margin-top:8px;overflow:hidden}
        .post-progress-bar{height:100%;background:linear-gradient(90deg,var(--p),var(--p2));border-radius:2px;width:0%;transition:width linear}

        /* â”€â”€ MUSIC PLAYER â”€â”€ */
        .music-player{background:var(--surface);border-radius:20px;border:1px solid var(--border);overflow:hidden}
        .player-header{padding:16px 18px;background:linear-gradient(135deg,rgba(91,94,244,0.15),rgba(139,92,246,0.1));border-bottom:1px solid var(--border);display:flex;align-items:center;gap:10px}
        .player-header h3{font-family:'Sora',sans-serif;font-size:15px;font-weight:800}
        .now-playing-wrap{padding:18px}
        .now-playing-art{width:56px;height:56px;border-radius:14px;background:linear-gradient(135deg,var(--p),var(--p2));display:flex;align-items:center;justify-content:center;font-size:24px;flex-shrink:0;animation:spin-art 8s linear infinite;animation-play-state:paused}
        .now-playing-art.playing{animation-play-state:running}
        @keyframes spin-art{to{transform:rotate(360deg)}}
        .now-playing-info{flex:1;min-width:0}
        .np-title{font-size:15px;font-weight:800;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
        .np-artist{font-size:12px;color:var(--muted);font-weight:600;margin-top:2px}
        .np-row{display:flex;align-items:center;gap:12px;margin-bottom:14px}

        /* Progress */
        .progress-wrap{margin-bottom:14px}
        .prog-bar{height:4px;background:var(--border);border-radius:4px;cursor:pointer;position:relative}
        .prog-fill{height:100%;background:linear-gradient(90deg,var(--p),var(--p2));border-radius:4px;pointer-events:none;transition:width 0.1s}
        .prog-times{display:flex;justify-content:space-between;font-size:10px;color:var(--muted);font-weight:600;margin-top:4px}

        /* Controls */
        .controls{display:flex;align-items:center;justify-content:center;gap:14px;margin-bottom:14px}
        .ctrl-btn{background:none;border:none;cursor:pointer;color:var(--muted);font-size:20px;transition:0.15s;padding:4px}
        .ctrl-btn:hover{color:var(--text);transform:scale(1.1)}
        .play-btn{width:46px;height:46px;border-radius:50%;background:linear-gradient(135deg,var(--p),var(--p2));border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:18px;color:white;box-shadow:0 4px 16px rgba(91,94,244,0.35);transition:0.15s}
        .play-btn:hover{transform:scale(1.08)}

        /* Volume */
        .volume-row{display:flex;align-items:center;gap:8px;padding:0 2px}
        .vol-icon{font-size:14px;color:var(--muted)}
        .vol-slider{flex:1;accent-color:var(--p);height:4px}

        /* Song list */
        .song-list{border-top:1px solid var(--border)}
        .song-item{display:flex;align-items:center;gap:10px;padding:11px 18px;cursor:pointer;transition:0.15s;border-bottom:1px solid rgba(255,255,255,0.04)}
        .song-item:last-child{border-bottom:none}
        .song-item:hover{background:rgba(91,94,244,0.08)}
        .song-item.active{background:rgba(91,94,244,0.12)}
        .song-num{font-size:11px;color:var(--muted);width:18px;text-align:center;flex-shrink:0;font-weight:700}
        .song-item.active .song-num{color:var(--p)}
        .song-info{flex:1;min-width:0}
        .song-name{font-size:13px;font-weight:700;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
        .song-item.active .song-name{color:var(--p)}
        .song-artist{font-size:11px;color:var(--muted)}
        .song-bars{display:none;gap:2px;align-items:flex-end;height:14px}
        .song-item.active .song-bars{display:flex}
        .sb{width:3px;background:var(--p);border-radius:1px}
        .sb:nth-child(1){animation:sb1 0.6s ease infinite;height:6px}
        .sb:nth-child(2){animation:sb1 0.6s ease infinite 0.15s;height:10px}
        .sb:nth-child(3){animation:sb1 0.6s ease infinite 0.3s;height:7px}
        @keyframes sb1{0%,100%{transform:scaleY(0.5)}50%{transform:scaleY(1.2)}}

        /* Empty states */
        .empty{text-align:center;padding:30px 20px;color:var(--muted)}
        .empty .ei{font-size:36px;margin-bottom:8px}
        .empty p{font-size:13px}

        /* Loading */
        .spin{border:3px solid var(--border);border-top:3px solid var(--p);border-radius:50%;width:24px;height:24px;animation:sp .8s linear infinite;margin:20px auto}
        @keyframes sp{to{transform:rotate(360deg)}}
    </style>
</head>
<body>

<!-- PARTICLES -->
<div class="particles" id="particles"></div>

<!-- TOP NAV -->
<div class="topnav">
    <div class="logo">ğŸ“º Screen</div>
    <div class="nav-links">
        <a href="/">ğŸ  Home</a>
        <a href="/dashboard">ğŸ“Š</a>
        <a href="/admin" class="admin-badge" id="adminLink" style="display:none">ğŸ›¡ï¸ Admin</a>
        <a href="/logout">ğŸšª</a>
    </div>
</div>

<!-- LIVE STATS TICKER -->
<div class="ticker-wrap">
    <div class="ticker-inner" id="tickerInner">
        <span class="ticker-item">âš¡ Loading stats...</span>
        <span class="ticker-item">âš¡ Loading stats...</span>
    </div>
</div>

<!-- MAIN -->
<div class="page">

    <!-- POSTS -->
    <div>
        <div class="section-label">ğŸ“¢ Posts & Offers</div>
        <div class="posts-carousel" id="postsCarousel">
            <div class="spin"></div>
        </div>
        <div class="post-progress"><div class="post-progress-bar" id="postProgressBar"></div></div>
        <div class="post-dots" id="postDots"></div>
    </div>

    <!-- MUSIC PLAYER -->
    <div>
        <div class="section-label">ğŸµ Music Player</div>
        <div class="music-player">
            <div class="player-header">
                <span>ğŸµ</span>
                <h3>Now Playing</h3>
                <span style="margin-left:auto;font-size:11px;color:var(--muted);font-weight:700" id="trackCount">Loading...</span>
            </div>
            <div class="now-playing-wrap">
                <div class="np-row">
                    <div class="now-playing-art" id="npArt">ğŸµ</div>
                    <div class="now-playing-info">
                        <div class="np-title" id="npTitle">Select a song</div>
                        <div class="np-artist" id="npArtist">â€”</div>
                    </div>
                </div>
                <div class="progress-wrap">
                    <div class="prog-bar" id="progBar" onclick="seekAudio(event)">
                        <div class="prog-fill" id="progFill" style="width:0%"></div>
                    </div>
                    <div class="prog-times">
                        <span id="curTime">0:00</span>
                        <span id="durTime">0:00</span>
                    </div>
                </div>
                <div class="controls">
                    <button class="ctrl-btn" onclick="prevTrack()" title="Previous">â®</button>
                    <button class="play-btn" id="playBtn" onclick="togglePlay()">â–¶</button>
                    <button class="ctrl-btn" onclick="nextTrack()" title="Next">â­</button>
                </div>
                <div class="volume-row">
                    <span class="vol-icon">ğŸ”ˆ</span>
                    <input type="range" class="vol-slider" id="volSlider" min="0" max="1" step="0.05" value="0.8" oninput="setVolume(this.value)">
                    <span class="vol-icon">ğŸ”Š</span>
                </div>
            </div>
            <div class="song-list" id="songList">
                <div class="spin"></div>
            </div>
        </div>
    </div>

</div>

<!-- Hidden audio -->
<audio id="audioEl" preload="metadata"></audio>

<script>
// â•â• PARTICLES â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
(function(){
    const colors=['#5b5ef4','#8b5cf6','#06d6a0','#f59e0b'];
    for(let i=0;i<18;i++){
        const d=document.createElement('div');
        d.className='particle';
        const sz=Math.random()*12+4;
        d.style.cssText=`width:${sz}px;height:${sz}px;background:${colors[i%colors.length]};left:${Math.random()*100}%;animation-duration:${8+Math.random()*14}s;animation-delay:${Math.random()*10}s`;
        document.getElementById('particles').appendChild(d);
    }
})();

// â•â• STATE â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let posts=[], currentPost=0, postTimer=null, postInterval=5000;
let tracks=[], currentTrack=0, isPlaying=false;
const audio=document.getElementById('audioEl');

// â•â• INIT â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window.addEventListener('DOMContentLoaded',()=>{
    fetch('/get_username').then(r=>r.json()).then(d=>{
        if(d.is_admin) document.getElementById('adminLink').style.display='inline-block';
    }).catch(()=>{});
    loadStats();
    loadPosts();
    loadMusic();
    setInterval(loadStats, 30000);
});

// â•â• TICKER / STATS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadStats(){
    try{
        const r=await fetch('/api/stats');
        const d=await r.json();
        const items=[
            `ğŸ‘¥ Total Users: ${d.total_users}`,
            `â­ Pro Users: ${d.pro_users}`,
            `ğŸ’¬ Today Queries: ${d.today_queries}`,
            `ğŸ“Š Total Queries: ${d.total_queries}`,
            `ğŸ• Updated: ${new Date().toLocaleTimeString()}`,
            `ğŸ¤– DS Agent Live`,
            `ğŸ‘¥ Total Users: ${d.total_users}`,
            `â­ Pro Users: ${d.pro_users}`,
            `ğŸ’¬ Today Queries: ${d.today_queries}`,
            `ğŸ“Š Total Queries: ${d.total_queries}`,
            `ğŸ• Updated: ${new Date().toLocaleTimeString()}`,
            `ğŸ¤– DS Agent Live`
        ];
        document.getElementById('tickerInner').innerHTML=
            items.map(t=>`<span class="ticker-item">${t}<span class="ticker-sep">â€¢</span></span>`).join('');
    }catch(e){console.error('Stats error',e);}
}

// â•â• POSTS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadPosts(){
    try{
        const r=await fetch('/api/screen/posts');
        posts=await r.json();
        if(!posts.length){
            document.getElementById('postsCarousel').innerHTML=`
                <div class="empty"><div class="ei">ğŸ“¢</div><p>Koi post nahi â€” Admin se add karwao!</p></div>`;
            return;
        }
        renderPosts();
        startAutoPlay();
    }catch(e){
        document.getElementById('postsCarousel').innerHTML=`<div class="empty"><div class="ei">âš ï¸</div><p>Posts load nahi huye</p></div>`;
    }
}

function renderPosts(){
    const car=document.getElementById('postsCarousel');
    const dots=document.getElementById('postDots');
    car.innerHTML=posts.map((p,i)=>`
        <div class="post-slide${i===0?' active':''}" id="slide_${i}">
            ${p.post_type==='image' && p.image_data
                ?`<div class="post-image-wrap">
                    <img src="data:${p.image_mime};base64,${p.image_data}" alt="${p.title}" loading="lazy">
                    <div class="post-image-overlay">
                        <div class="post-image-title">${p.title}</div>
                        ${p.affiliate_url?`<a href="${p.affiliate_url}" target="_blank" rel="noopener" class="aff-btn">ğŸ”— Check it out â†’</a>`:''}
                    </div>
                </div>`
                :`<div class="post-text">
                    <div>
                        <div class="post-title">${p.title}</div>
                        <div class="post-content">${(p.content||'').replace(/\n/g,'<br>')}</div>
                    </div>
                    ${p.affiliate_url?`<a href="${p.affiliate_url}" target="_blank" rel="noopener" class="aff-btn">ğŸ”— Check it out â†’</a>`:''}
                </div>`
            }
        </div>`).join('');
    dots.innerHTML=posts.map((_,i)=>`<div class="dot${i===0?' active':''}" onclick="goPost(${i})"></div>`).join('');
}

function goPost(idx){
    document.querySelectorAll('.post-slide').forEach(s=>s.classList.remove('active'));
    document.querySelectorAll('.dot').forEach(d=>d.classList.remove('active'));
    const slide=document.getElementById('slide_'+idx);
    if(slide) slide.classList.add('active');
    const dotEls=document.querySelectorAll('.dot');
    if(dotEls[idx]) dotEls[idx].classList.add('active');
    currentPost=idx;
    resetProgress();
}

function startAutoPlay(){
    if(posts.length<=1) return;
    resetProgress();
}

function resetProgress(){
    const bar=document.getElementById('postProgressBar');
    bar.style.transition='none';
    bar.style.width='0%';
    clearTimeout(postTimer);
    setTimeout(()=>{
        bar.style.transition=`width ${postInterval}ms linear`;
        bar.style.width='100%';
        postTimer=setTimeout(()=>{
            const next=(currentPost+1)%posts.length;
            goPost(next);
        }, postInterval);
    },50);
}

// â•â• MUSIC â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadMusic(){
    try{
        const r=await fetch('/api/music');
        tracks=await r.json();
        document.getElementById('trackCount').textContent=tracks.length+' tracks';
        if(!tracks.length){
            document.getElementById('songList').innerHTML=`
                <div class="empty"><div class="ei">ğŸµ</div><p>Koi gaana nahi â€” Admin se upload karwao!</p></div>`;
            return;
        }
        renderSongList();
        loadTrack(0, false);
    }catch(e){
        document.getElementById('songList').innerHTML=`<div class="empty"><p>Music load nahi hua</p></div>`;
    }
}

function renderSongList(){
    document.getElementById('songList').innerHTML=tracks.map((t,i)=>`
        <div class="song-item${i===0?' active':''}" id="song_${i}" onclick="loadTrack(${i},true)">
            <span class="song-num">${i+1}</span>
            <div class="song-info">
                <div class="song-name">${t.title}</div>
                <div class="song-artist">${t.artist||'Unknown'}</div>
            </div>
            <div class="song-bars"><div class="sb"></div><div class="sb"></div><div class="sb"></div></div>
        </div>`).join('');
}

function loadTrack(idx, autoPlay=false){
    if(!tracks[idx]) return;
    currentTrack=idx;
    const t=tracks[idx];
    document.getElementById('npTitle').textContent=t.title;
    document.getElementById('npArtist').textContent=t.artist||'Unknown';
    // Set audio src from base64
    audio.src=`data:${t.mime_type};base64,${t.audio_data}`;
    audio.load();
    // Update list highlight
    document.querySelectorAll('.song-item').forEach((el,i)=>el.classList.toggle('active',i===idx));
    // Scroll to active
    const el=document.getElementById('song_'+idx);
    if(el) el.scrollIntoView({block:'nearest',behavior:'smooth'});
    if(autoPlay){ audio.play(); setPlaying(true); }
    else{ setPlaying(false); }
}

function setPlaying(val){
    isPlaying=val;
    document.getElementById('playBtn').textContent=val?'â¸':'â–¶';
    document.getElementById('npArt').classList.toggle('playing',val);
}

function togglePlay(){
    if(!tracks.length) return;
    if(isPlaying){ audio.pause(); setPlaying(false); }
    else{ audio.play().then(()=>setPlaying(true)).catch(()=>{}); }
}

function prevTrack(){ loadTrack((currentTrack-1+tracks.length)%tracks.length, isPlaying); }
function nextTrack(){ loadTrack((currentTrack+1)%tracks.length, isPlaying); }
function setVolume(v){ audio.volume=parseFloat(v); }

function seekAudio(e){
    if(!audio.duration) return;
    const rect=e.currentTarget.getBoundingClientRect();
    const pct=(e.clientX-rect.left)/rect.width;
    audio.currentTime=pct*audio.duration;
}

function fmt(s){
    if(isNaN(s)) return '0:00';
    const m=Math.floor(s/60), sec=Math.floor(s%60);
    return m+':'+(sec<10?'0':'')+sec;
}

audio.addEventListener('timeupdate',()=>{
    if(!audio.duration) return;
    const pct=(audio.currentTime/audio.duration)*100;
    document.getElementById('progFill').style.width=pct+'%';
    document.getElementById('curTime').textContent=fmt(audio.currentTime);
});
audio.addEventListener('loadedmetadata',()=>{
    document.getElementById('durTime').textContent=fmt(audio.duration);
});
audio.addEventListener('ended',()=>{ nextTrack(); });
audio.volume=0.8;
</script>
</body>
</html>

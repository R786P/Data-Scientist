<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel</title>
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:Arial,sans-serif;background:#f0f2f8;color:#333;min-height:100vh}
        .topbar{background:#667eea;padding:14px 16px;display:flex;align-items:center;justify-content:space-between}
        .topbar h1{color:white;font-size:17px}
        .topbar a{color:white;text-decoration:none;font-size:12px;background:rgba(255,255,255,0.2);padding:5px 12px;border-radius:20px;margin-left:6px}
        .page{max-width:700px;margin:0 auto;padding:16px}
        .card{background:white;border-radius:12px;padding:18px;margin-bottom:16px;box-shadow:0 2px 8px rgba(0,0,0,0.08)}
        .card h2{font-size:15px;color:#667eea;margin-bottom:14px;font-weight:700}
        .tabs{display:flex;gap:6px;margin-bottom:12px}
        .tab{flex:1;padding:8px;border:2px solid #ddd;border-radius:8px;background:white;cursor:pointer;font-size:12px;font-weight:700;text-align:center}
        .tab.on{background:#667eea;color:white;border-color:#667eea}
        .panel{display:none}.panel.on{display:block}
        input,textarea,select{width:100%;padding:10px 12px;border:2px solid #ddd;border-radius:8px;font-size:13px;margin-bottom:10px;outline:none;font-family:Arial}
        input:focus,textarea:focus{border-color:#667eea}
        .type-row{display:flex;gap:6px;margin-bottom:10px}
        .type-btn{flex:1;padding:8px;border:2px solid #ddd;border-radius:8px;background:white;cursor:pointer;font-size:12px;font-weight:700}
        .type-btn.on{background:#667eea;color:white;border-color:#667eea}
        .img-field{display:none}
        .btn{width:100%;padding:11px;border:none;border-radius:8px;font-size:13px;font-weight:700;cursor:pointer;margin-bottom:8px}
        .btn-blue{background:#667eea;color:white}
        .btn-green{background:#11998e;color:white}
        .msg{padding:8px 12px;border-radius:8px;font-size:12px;font-weight:700;margin-bottom:8px;display:none}
        .msg.ok{background:#d4edda;color:#155724;display:block}
        .msg.err{background:#f8d7da;color:#721c24;display:block}
        .item{display:flex;align-items:center;gap:8px;padding:10px;background:#f8f9fc;border-radius:8px;margin-bottom:6px}
        .item-info{flex:1;min-width:0}
        .item-info strong{font-size:13px;display:block;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
        .item-info small{font-size:11px;color:#888}
        .del-btn{background:none;border:1px solid #f5a;border-radius:6px;color:#e44;padding:4px 10px;cursor:pointer;font-size:11px;font-weight:700;flex-shrink:0}
        .thumb{width:40px;height:40px;border-radius:6px;object-fit:cover;flex-shrink:0}
        table{width:100%;border-collapse:collapse}
        th,td{padding:9px 10px;text-align:left;border-bottom:1px solid #f0f0f0;font-size:12px}
        th{background:#f8f9ff;color:#667eea;font-weight:700}
        .badge{padding:2px 8px;border-radius:10px;font-size:10px;font-weight:700}
        .bp{background:#e8eaff;color:#667eea}
        .bf{background:#f0f0f0;color:#888}
        .ba{background:#fff3cd;color:#856404}
        .row2{display:grid;grid-template-columns:1fr 1fr;gap:8px}
        .prog{width:100%;height:5px;background:#eee;border-radius:4px;margin:6px 0;display:none;overflow:hidden}
        .prog-bar{height:100%;background:#667eea;border-radius:4px;transition:width 0.4s}
        .empty{text-align:center;padding:16px;color:#aaa;font-size:12px}
    </style>
</head>
<body>

<div class="topbar">
    <h1>üõ°Ô∏è Admin Panel</h1>
    <div>
        <a href="/screen">üì∫ Screen</a>
        <a href="/">üè† Home</a>
        <a href="/logout">Logout</a>
    </div>
</div>

<div class="page">

    <!-- SCREEN POSTS -->
    <div class="card">
        <h2>üì¢ Screen Posts</h2>
        <div class="msg" id="postMsg"></div>
        <div class="type-row">
            <button class="type-btn on" onclick="setType('text',this)">üìù Text</button>
            <button class="type-btn" onclick="setType('image',this)">üñºÔ∏è Image</button>
        </div>
        <input type="hidden" id="postType" value="text">
        <input type="text" id="postTitle" placeholder="Title / Heading">
        <textarea id="postContent" rows="3" placeholder="Content text..."></textarea>
        <div class="img-field" id="imgField">
            <input type="file" id="postImg" accept="image/*">
            <small style="color:#888;font-size:11px;display:block;margin-bottom:8px">‚úÖ GIF bhi chalega!</small>
        </div>
        <input type="url" id="postAff" placeholder="üîó Affiliate URL (optional)">
        <div class="prog" id="postProg"><div class="prog-bar" id="postProgBar" style="width:0%"></div></div>
        <button class="btn btn-blue" onclick="addPost()">‚ûï Add Post to TV Screen</button>
        <div id="postList"></div>
    </div>

    <!-- MUSIC -->
    <div class="card">
        <h2>üéµ Music Tracks</h2>
        <div class="msg" id="musicMsg"></div>
        <div class="row2">
            <input type="text" id="songTitle" placeholder="Song title">
            <input type="text" id="songArtist" placeholder="Artist name">
        </div>
        <input type="file" id="songFile" accept="audio/*,.mp3,.wav">
        <small style="color:#888;font-size:11px;display:block;margin-bottom:10px">MP3 / WAV ‚Äî Max 10MB</small>
        <div class="prog" id="musicProg"><div class="prog-bar" id="musicProgBar" style="width:0%"></div></div>
        <button class="btn btn-blue" onclick="uploadSong()">üéµ Upload Song</button>
        <div id="songList"></div>
    </div>

    <!-- AFFILIATE -->
    <div class="card">
        <h2>üîó Affiliate Links</h2>
        <div class="msg" id="affMsg"></div>
        <div class="row2">
            <input type="text" id="affTitle" placeholder="Title">
            <input type="url" id="affUrl" placeholder="URL">
        </div>
        <textarea id="affDesc" rows="2" placeholder="Description (optional)"></textarea>
        <button class="btn btn-blue" onclick="addAff()">‚ûï Add Affiliate Link</button>
        <div id="affList"></div>
    </div>

    <!-- USERS -->
    <div class="card">
        <h2>üë• Users</h2>
        <div class="msg" id="userMsg"></div>
        <table>
            <thead><tr><th>ID</th><th>Username</th><th>Role</th><th>Plan</th><th>Action</th></tr></thead>
            <tbody id="userBody"></tbody>
        </table>
    </div>

</div>

<script>
// ‚îÄ‚îÄ helpers ‚îÄ‚îÄ
function showMsg(id,txt,type){
    const el=document.getElementById(id);
    el.textContent=txt;el.className='msg '+type;
    setTimeout(()=>el.className='msg',3500);
}
function setType(type,btn){
    document.getElementById('postType').value=type;
    document.querySelectorAll('.type-btn').forEach(b=>b.className='type-btn');
    btn.className='type-btn on';
    document.getElementById('imgField').style.display=type==='image'?'block':'none';
    document.getElementById('postContent').placeholder=type==='image'?'Caption (optional)...':'Content text...';
}

// ‚îÄ‚îÄ POSTS ‚îÄ‚îÄ
async function loadPosts(){
    try{
        const r=await fetch('/api/screen/posts');
        const posts=await r.json();
        const c=document.getElementById('postList');
        if(!posts.length){c.innerHTML='<div class="empty">Koi post nahi ‚Äî upar se add karo!</div>';return;}
        c.innerHTML=posts.map(p=>`
            <div class="item">
                ${p.post_type==='image'&&p.image_data?`<img class="thumb" src="data:${p.image_mime};base64,${p.image_data}">`:`<span style="font-size:24px">${p.post_type==='image'?'üñºÔ∏è':'üìù'}</span>`}
                <div class="item-info">
                    <strong>${p.title}</strong>
                    <small>${p.post_type==='image'?'Image post':'Text post'}${p.affiliate_url?' ‚Ä¢ üîó Link':''}</small>
                </div>
                <button class="del-btn" onclick="delPost(${p.id})">üóë Del</button>
            </div>`).join('');
    }catch(e){document.getElementById('postList').innerHTML='<div class="empty">Load failed ‚Äî app.py check karo!</div>';}
}

async function addPost(){
    const title=document.getElementById('postTitle').value.trim();
    const type=document.getElementById('postType').value;
    if(!title){showMsg('postMsg','‚ö†Ô∏è Title required!','err');return;}
    const fd=new FormData();
    fd.append('title',title);
    fd.append('post_type',type);
    fd.append('content',document.getElementById('postContent').value);
    fd.append('affiliate_url',document.getElementById('postAff').value);
    if(type==='image'){
        const img=document.getElementById('postImg').files[0];
        if(!img){showMsg('postMsg','‚ö†Ô∏è Image select karo!','err');return;}
        fd.append('image',img);
    }
    const pw=document.getElementById('postProg');
    const pb=document.getElementById('postProgBar');
    pw.style.display='block';pb.style.width='40%';
    try{
        const r=await fetch('/api/screen/posts',{method:'POST',body:fd});
        pb.style.width='100%';
        const d=await r.json();
        setTimeout(()=>{pw.style.display='none';pb.style.width='0%';},500);
        if(d.message){
            showMsg('postMsg',d.message,'ok');
            document.getElementById('postTitle').value='';
            document.getElementById('postContent').value='';
            document.getElementById('postAff').value='';
            document.getElementById('postImg').value='';
            loadPosts();
        }else showMsg('postMsg',d.error||'Error!','err');
    }catch(e){pw.style.display='none';showMsg('postMsg','Failed! app.py check karo','err');}
}

async function delPost(id){
    if(!confirm('Delete?'))return;
    const r=await fetch('/api/screen/posts/'+id,{method:'DELETE'});
    const d=await r.json();
    showMsg('postMsg',d.message||d.error,d.message?'ok':'err');
    loadPosts();
}

// ‚îÄ‚îÄ MUSIC ‚îÄ‚îÄ
async function loadSongs(){
    try{
        const r=await fetch('/api/music');
        const tracks=await r.json();
        const c=document.getElementById('songList');
        if(!tracks.length){c.innerHTML='<div class="empty">Koi song nahi ‚Äî upar se upload karo!</div>';return;}
        c.innerHTML=tracks.map(t=>`
            <div class="item">
                <span style="font-size:24px">üéµ</span>
                <div class="item-info">
                    <strong>${t.title}</strong>
                    <small>${t.artist||'Unknown artist'}</small>
                </div>
                <button class="del-btn" onclick="delSong(${t.id})">üóë Del</button>
            </div>`).join('');
    }catch(e){document.getElementById('songList').innerHTML='<div class="empty">Load failed!</div>';}
}

async function uploadSong(){
    const file=document.getElementById('songFile').files[0];
    if(!file){showMsg('musicMsg','‚ö†Ô∏è File select karo!','err');return;}
    if(file.size>10*1024*1024){showMsg('musicMsg','‚ö†Ô∏è Max 10MB!','err');return;}
    const fd=new FormData();
    fd.append('audio',file);
    fd.append('title',document.getElementById('songTitle').value.trim()||file.name.replace(/\.[^/.]+$/,''));
    fd.append('artist',document.getElementById('songArtist').value.trim());
    const pw=document.getElementById('musicProg');
    const pb=document.getElementById('musicProgBar');
    pw.style.display='block';pb.style.width='20%';
    const t=setTimeout(()=>pb.style.width='70%',800);
    try{
        const r=await fetch('/api/music',{method:'POST',body:fd});
        clearTimeout(t);pb.style.width='100%';
        const d=await r.json();
        setTimeout(()=>{pw.style.display='none';pb.style.width='0%';},500);
        if(d.message){
            showMsg('musicMsg',d.message,'ok');
            document.getElementById('songTitle').value='';
            document.getElementById('songArtist').value='';
            document.getElementById('songFile').value='';
            loadSongs();
        }else showMsg('musicMsg',d.error||'Error!','err');
    }catch(e){clearTimeout(t);pw.style.display='none';showMsg('musicMsg','Upload failed!','err');}
}

async function delSong(id){
    if(!confirm('Delete?'))return;
    const r=await fetch('/api/music/'+id,{method:'DELETE'});
    const d=await r.json();
    showMsg('musicMsg',d.message||d.error,d.message?'ok':'err');
    loadSongs();
}

// ‚îÄ‚îÄ AFFILIATE ‚îÄ‚îÄ
async function loadAffs(){
    try{
        const r=await fetch('/affiliate_links');
        const links=await r.json();
        const c=document.getElementById('affList');
        if(!links.length){c.innerHTML='<div class="empty">Koi link nahi</div>';return;}
        c.innerHTML=links.map(l=>`
            <div class="item">
                <span style="font-size:22px">üîó</span>
                <div class="item-info"><strong>${l.title}</strong><small>${l.url}</small></div>
                <button class="del-btn" onclick="delAff(${l.id})">üóë Del</button>
            </div>`).join('');
    }catch(e){}
}

async function addAff(){
    const title=document.getElementById('affTitle').value.trim();
    const url=document.getElementById('affUrl').value.trim();
    if(!title||!url){showMsg('affMsg','‚ö†Ô∏è Title aur URL required!','err');return;}
    const r=await fetch('/admin/affiliate',{method:'POST',headers:{'Content-Type':'application/json'},
        body:JSON.stringify({title,url,description:document.getElementById('affDesc').value})});
    const d=await r.json();
    if(d.message){
        showMsg('affMsg',d.message,'ok');
        document.getElementById('affTitle').value='';
        document.getElementById('affUrl').value='';
        document.getElementById('affDesc').value='';
        loadAffs();
    }else showMsg('affMsg',d.error||'Error!','err');
}

async function delAff(id){
    if(!confirm('Delete?'))return;
    const r=await fetch('/admin/affiliate/'+id,{method:'DELETE'});
    const d=await r.json();
    showMsg('affMsg',d.message||d.error,d.message?'ok':'err');
    loadAffs();
}

// ‚îÄ‚îÄ USERS ‚îÄ‚îÄ
async function loadUsers(){
    try{
        const r=await fetch('/admin/users');
        const users=await r.json();
        document.getElementById('userBody').innerHTML=users.map(u=>`
            <tr>
                <td>${u.id}</td>
                <td><strong>${u.username}</strong>${u.is_admin?'<span class="badge ba" style="margin-left:4px">üëë</span>':''}</td>
                <td>${u.is_admin?'Admin':'User'}</td>
                <td><span class="badge ${u.plan==='pro'?'bp':'bf'}">${u.plan==='pro'?'‚≠ê Pro':'Free'}</span></td>
                <td>
                    <select id="p_${u.id}" style="padding:3px 6px;border:1px solid #ddd;border-radius:6px;font-size:11px">
                        <option value="free" ${u.plan==='free'?'selected':''}>Free</option>
                        <option value="pro" ${u.plan==='pro'?'selected':''}>Pro</option>
                    </select>
                    <button onclick="setPlan(${u.id})" style="margin-left:4px;padding:3px 8px;background:#11998e;color:white;border:none;border-radius:6px;cursor:pointer;font-size:11px">Set</button>
                </td>
            </tr>`).join('');
    }catch(e){}
}

async function setPlan(uid){
    const plan=document.getElementById('p_'+uid).value;
    const r=await fetch('/admin/set_plan',{method:'POST',headers:{'Content-Type':'application/json'},
        body:JSON.stringify({user_id:uid,plan,expires_days:plan==='pro'?30:null})});
    const d=await r.json();
    showMsg('userMsg',d.message||d.error,d.message?'ok':'err');
    loadUsers();
}

// Init
loadPosts();loadSongs();loadAffs();loadUsers();
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DS Agent</title>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;600;700&family=Sora:wght@600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lottie-web/5.12.2/lottie.min.js"></script>
    <style>
        :root {
            --p: #5b5ef4;
            --p2: #8b5cf6;
            --acc: #06d6a0;
            --bg: #f6f7fb;
            --surface: #ffffff;
            --text: #1a1a2e;
            --muted: #8890a4;
            --border: #e8eaf0;
            --radius: 18px;
        }
        * { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
        body { font-family:'DM Sans',sans-serif; background:var(--bg); min-height:100vh; overflow-x:hidden; }

        /* ‚ïê‚ïê OVERLAY (drawer backdrop) ‚ïê‚ïê */
        .overlay { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.4); z-index:400; backdrop-filter:blur(2px); }
        .overlay.show { display:block; }

        /* ‚ïê‚ïê SIDE DRAWER ‚ïê‚ïê */
        .drawer {
            position:fixed; top:0; left:0; bottom:0; width:280px;
            background:var(--surface); z-index:500;
            transform:translateX(-100%); transition:transform 0.3s cubic-bezier(0.4,0,0.2,1);
            display:flex; flex-direction:column; box-shadow:4px 0 30px rgba(0,0,0,0.12);
        }
        .drawer.open { transform:translateX(0); }
        .drawer-header {
            padding:20px 20px 16px;
            border-bottom:1px solid var(--border);
            display:flex; align-items:center; gap:12px;
        }
        .drawer-avatar {
            width:42px; height:42px; border-radius:50%;
            background:linear-gradient(135deg,var(--p),var(--p2));
            display:flex; align-items:center; justify-content:center;
            color:white; font-weight:700; font-size:16px; flex-shrink:0;
        }
        .drawer-user h4 { font-size:15px; font-weight:700; color:var(--text); }
        .drawer-user span { font-size:11px; color:var(--muted); font-weight:500; }
        .plan-pill {
            display:inline-block; padding:2px 8px; border-radius:20px;
            font-size:10px; font-weight:700; margin-left:4px;
        }
        .plan-pill.free { background:#f0f0f0; color:#888; }
        .plan-pill.pro { background:linear-gradient(135deg,var(--p),var(--p2)); color:white; }

        .drawer-section { padding:12px 12px 4px; }
        .drawer-section-label {
            font-size:10px; font-weight:700; color:var(--muted);
            text-transform:uppercase; letter-spacing:1.2px;
            padding:0 8px; margin-bottom:6px;
        }
        .drawer-item {
            display:flex; align-items:center; gap:12px;
            padding:11px 12px; border-radius:12px; cursor:pointer;
            text-decoration:none; color:var(--text);
            font-size:14px; font-weight:500; transition:0.15s;
        }
        .drawer-item:hover { background:#f4f4f8; }
        .drawer-item.active { background:linear-gradient(135deg,#eef0ff,#f0e8ff); color:var(--p); font-weight:700; }
        .drawer-item .di-icon { font-size:18px; width:28px; text-align:center; }
        .drawer-item .di-badge { margin-left:auto; font-size:9px; font-weight:800; background:linear-gradient(135deg,var(--p),var(--p2)); color:white; padding:2px 7px; border-radius:8px; }
        .drawer-footer { margin-top:auto; padding:16px 12px; border-top:1px solid var(--border); }
        .drawer-footer a { display:flex; align-items:center; gap:10px; padding:10px 12px; border-radius:12px; color:var(--muted); font-size:13px; font-weight:600; text-decoration:none; transition:0.15s; }
        .drawer-footer a:hover { background:#fef0f0; color:#e74c3c; }

        /* ‚ïê‚ïê TOP BAR ‚ïê‚ïê */
        .topbar {
            position:sticky; top:0; z-index:200;
            display:flex; align-items:center; justify-content:space-between;
            padding:14px 18px; background:rgba(246,247,251,0.9);
            backdrop-filter:blur(12px); border-bottom:1px solid transparent;
        }
        .menu-btn {
            width:38px; height:38px; border:none; background:var(--surface);
            border-radius:12px; display:flex; align-items:center; justify-content:center;
            cursor:pointer; box-shadow:0 2px 8px rgba(0,0,0,0.08); font-size:18px;
            transition:0.15s;
        }
        .menu-btn:hover { background:#eef0ff; }
        .topbar-title { font-family:'Sora',sans-serif; font-size:16px; font-weight:700; color:var(--text); }
        .topbar-right { display:flex; align-items:center; gap:8px; }
        .top-avatar {
            width:34px; height:34px; border-radius:50%;
            background:linear-gradient(135deg,var(--p),var(--p2));
            display:flex; align-items:center; justify-content:center;
            color:white; font-weight:700; font-size:13px; cursor:pointer;
        }

        /* ‚ïê‚ïê MAIN CONTENT ‚ïê‚ïê */
        .main {
            display:flex; flex-direction:column; align-items:center;
            min-height:calc(100vh - 66px);
            padding:0 0 140px;
        }

        /* ‚ïê‚ïê CENTER SECTION ‚ïê‚ïê */
        .center-section {
            display:flex; flex-direction:column; align-items:center;
            padding:30px 20px 0; width:100%; max-width:600px;
            text-align:center;
        }

        /* ‚ïê‚ïê MASCOT ‚ïê‚ïê */
        .mascot-wrap { position:relative; margin-bottom:10px; cursor:pointer; }
        #lottie-bot { width:120px; height:120px; }
        .speech-bubble {
            position:absolute; bottom:100%; left:50%; transform:translateX(-50%);
            background:var(--surface); border-radius:14px; padding:8px 14px;
            font-size:12px; font-weight:600; color:var(--text); white-space:nowrap;
            box-shadow:0 4px 20px rgba(0,0,0,0.1); border:1px solid var(--border);
            opacity:0; pointer-events:none; margin-bottom:8px;
            transition:all 0.3s cubic-bezier(0.34,1.56,0.64,1);
            transform:translateX(-50%) scale(0.85);
        }
        .speech-bubble::after { content:''; position:absolute; top:100%; left:50%; transform:translateX(-50%); border:7px solid transparent; border-top-color:var(--surface); }
        .speech-bubble.show { opacity:1; transform:translateX(-50%) scale(1); }

        /* ‚ïê‚ïê WELCOME TEXT ‚ïê‚ïê */
        .welcome-small { font-size:14px; color:var(--muted); font-weight:500; margin-bottom:4px; }
        .welcome-name {
            font-family:'Sora',sans-serif; font-size:28px; font-weight:800;
            background:linear-gradient(135deg,var(--p),var(--p2));
            -webkit-background-clip:text; -webkit-text-fill-color:transparent;
            margin-bottom:6px;
        }
        .welcome-sub { font-size:14px; color:var(--muted); font-weight:500; margin-bottom:24px; }

        /* ‚ïê‚ïê UPLOAD ZONE ‚ïê‚ïê */
        .upload-zone {
            width:100%; border:2px dashed #d0d4e8; border-radius:16px;
            padding:18px; text-align:center; cursor:pointer;
            background:var(--surface); transition:0.2s; margin-bottom:16px;
        }
        .upload-zone:hover { border-color:var(--p); background:#f8f8ff; }
        .upload-zone p { color:var(--p); font-size:14px; font-weight:600; margin-bottom:2px; }
        .upload-zone small { color:var(--muted); font-size:12px; }
        .upload-zone.synced { border-color:var(--acc); border-style:solid; background:#f0fdf8; }
        .upload-zone.synced p { color:#059669; }

        /* ‚ïê‚ïê REACTION MESSAGE ‚ïê‚ïê */
        .reaction-row {
            display:flex; align-items:flex-end; gap:8px;
            width:100%; max-width:600px; padding:0 16px;
            margin-bottom:12px;
        }
        .r-char { font-size:30px; flex-shrink:0; line-height:1; }
        .r-bubble {
            background:var(--surface); border-radius:16px 16px 16px 4px;
            padding:10px 14px; font-size:13px; font-weight:500; color:var(--text);
            box-shadow:0 2px 12px rgba(0,0,0,0.06); border:1px solid var(--border);
            max-width:85%; position:relative; line-height:1.5; white-space:pre-wrap;
            word-wrap:break-word;
        }
        .r-bubble.user { background:linear-gradient(135deg,var(--p),var(--p2)); color:white; border-radius:16px 16px 4px 16px; border:none; margin-left:auto; }
        .r-bubble.ai-mode { background:linear-gradient(135deg,#f0f0ff,#f5f0ff); }
        .reaction-row.user-row { flex-direction:row-reverse; }
        .r-actions { position:absolute; top:4px; right:6px; display:flex; gap:2px; opacity:0; transition:0.2s; }
        .r-bubble:hover .r-actions { opacity:1; }
        .r-action-btn { background:rgba(0,0,0,0.08); border:none; border-radius:4px; padding:2px 5px; cursor:pointer; font-size:10px; }

        /* Typing */
        .typing-dots span { height:6px; width:6px; background:var(--p); border-radius:50%; display:inline-block; margin:0 2px; animation:tdot 1.4s infinite; }
        .typing-dots span:nth-child(2){animation-delay:0.2s}
        .typing-dots span:nth-child(3){animation-delay:0.4s}
        @keyframes tdot{0%,60%,100%{transform:translateY(0)}30%{transform:translateY(-5px)}}

        /* ‚ïê‚ïê CHAT BOX (hidden scroll area) ‚ïê‚ïê */
        .chat-area {
            width:100%; max-width:600px;
            display:flex; flex-direction:column;
            gap:0; padding-bottom:4px;
            overflow-y:auto; max-height:340px;
        }

        /* ‚ïê‚ïê AI TOGGLE inside input area ‚ïê‚ïê */
        .ai-toggle-row {
            display:flex; align-items:center; justify-content:center; gap:8px;
            padding:6px 0; margin-bottom:4px;
        }
        .ai-toggle-row span { font-size:11px; color:var(--muted); font-weight:600; }
        .toggle-sw { position:relative; width:42px; height:22px; }
        .toggle-sw input { opacity:0; width:0; height:0; }
        .toggle-sl { position:absolute; cursor:pointer; inset:0; background:#d0d4e8; border-radius:22px; transition:0.3s; }
        .toggle-sl:before { position:absolute; content:""; height:16px; width:16px; left:3px; bottom:3px; background:white; border-radius:50%; transition:0.3s; }
        input:checked+.toggle-sl { background:linear-gradient(135deg,var(--p),var(--p2)); }
        input:checked+.toggle-sl:before { transform:translateX(20px); }
        .ai-on-badge { background:linear-gradient(135deg,var(--p),var(--p2)); color:white; padding:2px 8px; border-radius:8px; font-size:10px; font-weight:800; display:none; }
        .ai-on-badge.on { display:inline-block; }

        /* ‚ïê‚ïê BOTTOM INPUT BAR (fixed) ‚ïê‚ïê */
        .input-bar {
            position:fixed; bottom:0; left:0; right:0;
            background:var(--bg); padding:10px 16px 16px;
            border-top:1px solid var(--border);
            z-index:300;
        }
        .input-wrap {
            display:flex; align-items:center; gap:8px;
            background:var(--surface); border-radius:16px;
            padding:8px 10px 8px 14px;
            box-shadow:0 2px 16px rgba(0,0,0,0.1);
            border:1px solid var(--border);
        }
        .input-wrap input {
            flex:1; border:none; outline:none; font-size:15px;
            font-family:'DM Sans',sans-serif; background:transparent;
            color:var(--text); font-weight:500;
        }
        .input-wrap input::placeholder { color:#b0b8cc; }
        .input-wrap input:disabled { cursor:not-allowed; opacity:0.5; }
        .input-btn {
            width:38px; height:38px; border:none; border-radius:12px;
            cursor:pointer; display:flex; align-items:center; justify-content:center;
            font-size:16px; transition:0.15s; flex-shrink:0; background:transparent;
        }
        .input-btn:hover { background:#f0f0f8; }
        .plus-btn { background:#f0f0f8; color:var(--p); font-size:20px; font-weight:300; }
        .plus-btn:hover { background:#e8e8ff; }
        .voice-btn.listening { background:linear-gradient(135deg,#ef4444,#f97316); color:white; animation:pulse-v 1s infinite; }
        @keyframes pulse-v { 0%,100%{box-shadow:0 0 0 0 rgba(239,68,68,0.4)}50%{box-shadow:0 0 0 8px rgba(239,68,68,0)}}
        .send-btn { background:linear-gradient(135deg,var(--p),var(--p2)); color:white; }
        .send-btn:hover { opacity:0.9; transform:scale(1.05); }
        .send-btn:disabled { background:#d0d4e8; cursor:not-allowed; transform:none; }
        .voice-status { font-size:11px; color:var(--p); font-weight:600; text-align:center; margin-top:4px; height:14px; }

        /* ‚ïê‚ïê PLUS MENU (popup above input) ‚ïê‚ïê */
        .plus-menu {
            position:fixed; bottom:80px; left:16px; right:16px;
            background:var(--surface); border-radius:20px;
            box-shadow:0 -4px 30px rgba(0,0,0,0.12);
            border:1px solid var(--border);
            padding:16px; z-index:400;
            transform:translateY(20px) scale(0.95); opacity:0;
            pointer-events:none; transition:all 0.25s cubic-bezier(0.34,1.56,0.64,1);
        }
        .plus-menu.show { transform:translateY(0) scale(1); opacity:1; pointer-events:all; }
        .plus-menu-title { font-size:11px; font-weight:700; color:var(--muted); text-transform:uppercase; letter-spacing:1px; margin-bottom:12px; }
        .pm-grid { display:grid; grid-template-columns:repeat(4,1fr); gap:8px; }
        .pm-item {
            display:flex; flex-direction:column; align-items:center; gap:5px;
            padding:12px 6px; border-radius:14px; cursor:pointer;
            background:#f8f9fc; border:1px solid var(--border); transition:0.15s;
        }
        .pm-item:hover { background:#eef0ff; border-color:var(--p); }
        .pm-item .pm-icon { font-size:22px; }
        .pm-item .pm-label { font-size:10px; font-weight:700; color:var(--text); text-align:center; line-height:1.2; }
        .pm-item .pm-pro { font-size:8px; color:var(--p); font-weight:800; }
        .pm-voice-row { display:flex; gap:8px; margin-top:10px; padding-top:10px; border-top:1px solid var(--border); align-items:center; }
        .pm-voice-row label { font-size:12px; font-weight:700; color:var(--text); flex-shrink:0; }
        .gender-btn { padding:5px 14px; border-radius:20px; border:2px solid var(--border); cursor:pointer; font-size:12px; font-weight:700; background:white; transition:0.15s; font-family:'DM Sans',sans-serif; }
        .gender-btn.active { border-color:var(--p); background:linear-gradient(135deg,var(--p),var(--p2)); color:white; }
        .speed-wrap { display:flex; align-items:center; gap:6px; margin-left:auto; }
        .speed-wrap label { font-size:10px; color:var(--muted); font-weight:600; }
        .speed-wrap input { width:70px; accent-color:var(--p); }

        /* ‚ïê‚ïê SPEAKING INDICATOR ‚ïê‚ïê */
        .speaking-row { display:none; justify-content:center; gap:3px; align-items:center; padding:4px 0; }
        .speaking-row.on { display:flex; }
        .sp-bar { width:3px; height:14px; background:var(--p); border-radius:2px; }
        .sp-bar:nth-child(1){animation:sw .6s ease infinite 0s}
        .sp-bar:nth-child(2){animation:sw .6s ease infinite .1s}
        .sp-bar:nth-child(3){animation:sw .6s ease infinite .2s}
        .sp-bar:nth-child(4){animation:sw .6s ease infinite .3s}
        .sp-bar:nth-child(5){animation:sw .6s ease infinite .4s}
        @keyframes sw{0%,100%{transform:scaleY(1)}50%{transform:scaleY(1.8)}}

        /* ‚ïê‚ïê SESSION EXPIRED ‚ïê‚ïê */
        .sess-overlay { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.7); justify-content:center; align-items:center; z-index:9000; }
        .sess-overlay.show { display:flex; }
        .sess-card { background:white; border-radius:20px; padding:28px; text-align:center; max-width:300px; width:90%; }
        .sess-card h3 { color:#ef4444; font-size:18px; font-weight:800; margin-bottom:8px; }
        .sess-card p { color:var(--muted); font-size:13px; margin-bottom:18px; }
        .sess-card a { display:block; padding:12px; background:linear-gradient(135deg,var(--p),var(--p2)); color:white; border-radius:12px; text-decoration:none; font-weight:700; }

        /* ‚ïê‚ïê AFFILIATE POPUP ‚ïê‚ïê */
        .aff-overlay { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.55); justify-content:center; align-items:center; z-index:8000; backdrop-filter:blur(3px); }
        .aff-overlay.show { display:flex; }
        .aff-card { background:white; border-radius:22px; padding:26px 22px; width:90%; max-width:360px; text-align:center; animation:pop .4s cubic-bezier(0.34,1.56,0.64,1); }
        @keyframes pop { 0%{transform:scale(0.7);opacity:0}100%{transform:scale(1);opacity:1} }
        .aff-sponsor { font-size:10px; color:#aaa; font-weight:700; text-transform:uppercase; letter-spacing:1px; margin-bottom:8px; }
        .aff-card h3 { font-family:'Sora',sans-serif; font-size:18px; font-weight:700; color:var(--text); margin-bottom:6px; }
        .aff-card p { font-size:13px; color:var(--muted); margin-bottom:16px; }
        .aff-visit { display:block; padding:12px; background:linear-gradient(135deg,var(--p),var(--p2)); color:white; border-radius:12px; text-decoration:none; font-weight:700; font-size:14px; margin-bottom:8px; }
        .aff-skip { background:none; border:none; cursor:pointer; color:var(--muted); font-size:12px; font-weight:600; font-family:'DM Sans',sans-serif; padding:4px; }

        /* ‚ïê‚ïê DOWNLOAD PANEL (shown inside plus menu when available) ‚ïê‚ïê */
        .dl-section { margin-top:10px; padding-top:10px; border-top:1px solid var(--border); display:none; }
        .dl-section.show { display:block; }
        .dl-title { font-size:11px; font-weight:700; color:var(--muted); text-transform:uppercase; letter-spacing:1px; margin-bottom:8px; }
        .dl-btns { display:flex; flex-wrap:wrap; gap:6px; }
        .dl-btn { padding:6px 12px; border-radius:10px; border:1px solid var(--border); background:white; font-size:11px; font-weight:700; cursor:pointer; font-family:'DM Sans',sans-serif; color:var(--text); transition:0.15s; display:flex; align-items:center; gap:4px; }
        .dl-btn:hover { background:#eef0ff; border-color:var(--p); color:var(--p); }
        .dl-btn:disabled { opacity:0.4; cursor:not-allowed; }
        .email-dl-btn { width:100%; padding:10px; background:linear-gradient(135deg,#059669,#34d399); color:white; border:none; border-radius:10px; font-size:13px; font-weight:700; cursor:pointer; font-family:'DM Sans',sans-serif; margin-top:8px; }

        /* ‚ïê‚ïê EMAIL MODAL ‚ïê‚ïê */
        .modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5); justify-content:center; align-items:center; z-index:7000; }
        .modal.show { display:flex; }
        .modal-card { background:white; border-radius:20px; padding:24px; width:90%; max-width:360px; }
        .modal-card h3 { font-size:17px; font-weight:800; color:var(--text); margin-bottom:14px; }
        .modal-card input { width:100%; padding:11px 14px; border:2px solid var(--border); border-radius:12px; font-size:14px; font-family:'DM Sans',sans-serif; outline:none; margin-bottom:12px; }
        .modal-card input:focus { border-color:var(--p); }
        .modal-btns { display:flex; gap:8px; }
        .modal-btns button { flex:1; padding:10px; border:none; border-radius:10px; cursor:pointer; font-weight:700; font-family:'DM Sans',sans-serif; }
        .m-send { background:linear-gradient(135deg,var(--p),var(--p2)); color:white; }
        .m-cancel { background:#f0f0f0; color:var(--text); }

        /* ‚ïê‚ïê VIEWER ‚ïê‚ïê */
        .viewer-modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.88); justify-content:center; align-items:center; z-index:9000; }
        .viewer-modal.show { display:flex; }
        .viewer-content { background:white; border-radius:20px; padding:18px; width:96%; max-width:740px; max-height:88vh; overflow:auto; position:relative; }
        .viewer-content img { max-width:100%; border-radius:10px; }
        .viewer-content iframe { width:100%; height:460px; border:none; }
        .v-close { position:absolute; top:10px; right:14px; font-size:26px; cursor:pointer; color:var(--p); font-weight:900; line-height:1; }

        /* ‚ïê‚ïê QUERY BAR ‚ïê‚ïê */
        .query-bar { display:none; align-items:center; gap:8px; background:var(--surface); border-radius:12px; padding:8px 14px; margin:8px 16px 0; box-shadow:0 1px 6px rgba(0,0,0,0.06); }
        .query-bar.show { display:flex; }
        .qb-text { font-size:11px; font-weight:700; color:var(--muted); white-space:nowrap; }
        .qb-prog { flex:1; height:5px; background:#eee; border-radius:4px; overflow:hidden; }
        .qb-fill { height:100%; background:linear-gradient(90deg,var(--p),var(--p2)); border-radius:4px; transition:0.5s; }
        .qb-link { font-size:11px; color:var(--p); font-weight:800; text-decoration:none; white-space:nowrap; }

        .loader { border:3px solid #eee; border-top:3px solid var(--p); border-radius:50%; width:16px; height:16px; animation:spin .8s linear infinite; display:inline-block; vertical-align:middle; }
        @keyframes spin{to{transform:rotate(360deg)}}
        @keyframes tvsl{0%{opacity:0;transform:translateX(18px)}100%{opacity:1;transform:translateX(0)}}

        /* ‚ïê‚ïê FLOATING LED TV ‚ïê‚ïê */
        .led-tv{position:fixed;top:80px;right:12px;width:145px;z-index:500;cursor:grab;user-select:none;-webkit-user-select:none;box-shadow:0 6px 24px rgba(91,94,244,0.35)}
        .led-tv:active{cursor:grabbing}

        /* ‚ïê‚ïê TV REMOTE ‚ïê‚ïê */
        .tv-remote{position:fixed;top:80px;right:170px;width:64px;z-index:499;cursor:grab;user-select:none;-webkit-user-select:none;box-shadow:0 4px 14px rgba(0,0,0,0.4);transition:opacity 0.2s}
        .tv-remote.hidden{opacity:0;pointer-events:none}
        .remote-body{background:linear-gradient(170deg,#1a1a2e,#0d0d1a);border-radius:14px 14px 22px 22px;border:2px solid #2a2a4a;box-shadow:inset 0 0 12px rgba(91,94,244,0.1),0 0 0 1px #3a3a5a;padding:8px 6px 14px;display:flex;flex-direction:column;gap:5px;align-items:center;position:relative}
        .r-brand{font-size:6px;font-weight:800;color:#5b5ef4;letter-spacing:1.5px}
        .r-power{width:20px;height:20px;border-radius:50%;background:linear-gradient(135deg,#ef4444,#dc2626);border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:10px;color:white;box-shadow:0 0 8px rgba(239,68,68,0.4);transition:0.15s}
        .r-power:hover{transform:scale(1.1)}
        .r-power:active{transform:scale(0.9)}
        .r-div{width:46px;height:1px;background:#2a2a4a}
        .r-dpad{display:grid;grid-template-columns:repeat(3,18px);grid-template-rows:repeat(3,16px);gap:2px}
        .dp{background:#1e1e38;border:1px solid #3a3a5a;border-radius:4px;cursor:pointer;color:#8890a4;font-size:9px;display:flex;align-items:center;justify-content:center;transition:0.15s}
        .dp:hover{background:#2a2a4a;color:#fff}
        .dp:active{background:#5b5ef4;color:#fff;transform:scale(0.88)}
        .dp.mid{background:linear-gradient(135deg,#5b5ef4,#8b5cf6);color:white;border-radius:50%;border-color:#5b5ef4;font-size:7px}
        .dp.empty{background:transparent;border:none;pointer-events:none}
        .r-row{display:flex;align-items:center;gap:3px;width:50px}
        .r-sm-btn{background:#1e1e38;border:1px solid #3a3a5a;border-radius:5px;cursor:pointer;color:#8890a4;width:16px;height:16px;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:900;transition:0.15s;flex-shrink:0;line-height:1}
        .r-sm-btn:hover{background:#2a2a4a;color:#fff}
        .r-sm-btn:active{background:#5b5ef4;color:#fff;transform:scale(0.9)}
        .r-disp{flex:1;text-align:center;font-size:7.5px;font-weight:800;background:#0f0f1a;border-radius:4px;padding:2px 0}
        .r-grid2{display:grid;grid-template-columns:1fr 1fr;gap:3px;width:50px}
        .r-gbtn{background:#1e1e38;border:1px solid #3a3a5a;border-radius:6px;cursor:pointer;color:#8890a4;font-size:6.5px;font-weight:700;padding:4px 2px;text-align:center;transition:0.15s;font-family:'DM Sans',sans-serif;line-height:1.4}
        .r-gbtn:hover{background:#2a2a4a;color:#fff}
        .r-gbtn:active{transform:scale(0.9)}
        .r-gbtn.on{background:linear-gradient(135deg,#5b5ef4,#8b5cf6);color:white;border-color:#5b5ef4}
        .r-gbtn span{display:block;font-size:11px;margin-bottom:1px}
        .r-bright-lbl{font-size:6px;color:#4a4a7a;font-weight:700;align-self:flex-start;width:50px}
        .r-bright-track{width:50px;height:5px;background:#1a1a3a;border-radius:3px;cursor:pointer;overflow:hidden}
        .r-bright-fill{height:100%;background:linear-gradient(90deg,#f59e0b,#fbbf24);border-radius:3px;width:80%;pointer-events:none}
        .r-resize{position:absolute;bottom:3px;right:3px;width:13px;height:13px;cursor:se-resize;display:flex;align-items:center;justify-content:center}
        .remote-toggle{position:fixed;z-index:498;background:#1a1a2e;border:1.5px solid #3a3a5a;border-radius:8px;cursor:pointer;color:#8890a4;font-size:9px;padding:3px 8px;font-weight:700;box-shadow:0 2px 8px rgba(0,0,0,0.3);transition:0.2s;font-family:'DM Sans',sans-serif}
        .remote-toggle:hover{color:#fff;border-color:#5b5ef4}

        /* Admin editor */
        .tap-wrap{position:fixed;width:265px;background:white;border-radius:16px;box-shadow:0 8px 32px rgba(0,0,0,0.18);border:1px solid #e8eaf0;z-index:601;opacity:0;pointer-events:none;transform:scale(0.88);transition:all 0.25s cubic-bezier(0.34,1.56,0.64,1);max-height:72vh;overflow-y:auto}
        .tap-wrap.show{opacity:1;pointer-events:all;transform:scale(1)}
        .tap-inp{width:100%;padding:7px 10px;border:1.5px solid #e8eaf0;border-radius:8px;font-size:11px;font-family:'DM Sans',sans-serif;margin-bottom:7px;outline:none;box-sizing:border-box}
        .tap-inp:focus{border-color:#5b5ef4}
        .tap-btn-main{width:100%;padding:8px;background:linear-gradient(135deg,#5b5ef4,#8b5cf6);color:white;border:none;border-radius:8px;font-size:11px;font-weight:800;cursor:pointer;font-family:'DM Sans',sans-serif;margin-bottom:8px}
        .tap-item{display:flex;align-items:center;gap:6px;padding:6px;background:#f8f8fc;border-radius:8px;margin-bottom:5px}
        .tap-del{background:none;border:1px solid #fca5a5;border-radius:5px;color:#ef4444;cursor:pointer;font-size:9px;padding:2px 6px;flex-shrink:0}
    </style>
</head>
<body>

<!-- SESSION EXPIRED -->
<div class="sess-overlay" id="sessOverlay">
    <div class="sess-card">
        <h3>üîí Session Expire!</h3>
        <p>Aapka account kisi aur device pe login hua. Please dobara login karo.</p>
        <a href="/login">üîë Login Again</a>
    </div>
</div>

<!-- AFFILIATE POPUP -->
<div class="aff-overlay" id="affOverlay">
    <div class="aff-card">
        <div class="aff-sponsor">üì¢ Sponsored</div>
        <h3 id="affTitle">Partner Offer</h3>
        <p id="affDesc">Check out this amazing tool!</p>
        <a href="#" id="affLink" class="aff-visit" target="_blank" rel="noopener" onclick="proceedDl()">Visit Partner ‚Üí</a>
        <button class="aff-skip" onclick="proceedDl()">Skip & Download</button>
    </div>
</div>

<!-- OVERLAY (drawer) -->
<div class="overlay" id="overlay" onclick="closeDrawer()"></div>

<!-- SIDE DRAWER -->
<div class="drawer" id="drawer">
    <div class="drawer-header">
        <div class="drawer-avatar" id="drawerAvatar">?</div>
        <div class="drawer-user">
            <h4 id="drawerName">Loading...</h4>
            <span id="drawerSub">Free plan <span class="plan-pill free" id="drawerPill">Free</span></span>
        </div>
    </div>

    <div class="drawer-section">
        <div class="drawer-section-label">Main</div>
        <a class="drawer-item active" href="/">
            <span class="di-icon">üè†</span> Home
        </a>
        <a class="drawer-item" href="/dashboard">
            <span class="di-icon">üìä</span> Dashboard
            <span class="di-badge">Pro</span>
        </a>
        <a class="drawer-item" href="/pricing">
            <span class="di-icon">‚≠ê</span> Upgrade to Pro
        </a>
    </div>

    <div class="drawer-section" id="adminSection" style="display:none">
        <div class="drawer-section-label">Admin</div>
        <a class="drawer-item" href="/admin">
            <span class="di-icon">üõ°Ô∏è</span> Admin Panel
        </a>
        <a class="drawer-item" onclick="openDrawerAffiliate()">
            <span class="di-icon">üîó</span> Affiliate Links
        </a>
        <a class="drawer-item" onclick="openDrawerUsers()">
            <span class="di-icon">üë•</span> Manage Users
        </a>
    </div>

    <div class="drawer-section">
        <div class="drawer-section-label">Quick Commands</div>
        <div class="drawer-item" onclick="quickCmd('dashboard')"><span class="di-icon">üìà</span> Show Dashboard</div>
        <div class="drawer-item" onclick="quickCmd('kpi')"><span class="di-icon">üéØ</span> KPI Cards</div>
        <div class="drawer-item" onclick="quickCmd('top 5')"><span class="di-icon">üèÜ</span> Top 5</div>
        <div class="drawer-item" onclick="quickCmd('average')"><span class="di-icon">üî¢</span> Average</div>
        <div class="drawer-item" onclick="quickCmd('bar chart')"><span class="di-icon">üìâ</span> Bar Chart</div>
    </div>

    <div class="drawer-footer">
        <a href="/logout">üö™ Logout</a>
    </div>
</div>

<!-- TOP BAR -->
<div class="topbar">
    <button class="menu-btn" onclick="openDrawer()">‚ò∞</button>
    <span class="topbar-title">ü§ñ DS Agent</span>
    <div class="topbar-right">
        <div class="top-avatar" id="topAvatar" onclick="openDrawer()">?</div>
    </div>
</div>

<!-- QUERY PROGRESS BAR -->
<div class="query-bar" id="queryBar">
    <span class="qb-text" id="qbText">0/10</span>
    <div class="qb-prog"><div class="qb-fill" id="qbFill" style="width:0%"></div></div>
    <a href="/pricing" class="qb-link">‚≠ê Upgrade</a>
</div>

<!-- MAIN -->
<div class="main">
    <div class="center-section">

        <!-- MASCOT -->
        <div class="mascot-wrap" onclick="mascotTap()">
            <div class="speech-bubble" id="bubble">Namaste! üëã</div>
            <div id="lottie-bot"></div>
        </div>

        <!-- SPEAKING -->
        <div class="speaking-row" id="speakRow">
            <div class="sp-bar"></div><div class="sp-bar"></div>
            <div class="sp-bar"></div><div class="sp-bar"></div><div class="sp-bar"></div>
        </div>

        <!-- WELCOME -->
        <div class="welcome-small">‡§®‡§Æ‡§∏‡•ç‡§§‡•á,</div>
        <div class="welcome-name" id="wName">...</div>
        <div class="welcome-sub" id="wSub">‡§ï‡§π‡§æ‡§Å ‡§∏‡•á ‡§∂‡•Å‡§∞‡•Å‡§Ü‡§§ ‡§ï‡§∞‡•á‡§Ç?</div>

        <!-- UPLOAD -->
        <div class="upload-zone" id="uploadZone" onclick="document.getElementById('fileIn').click()">
            <p id="uploadTxt">üìÅ CSV / Excel Upload ‡§ï‡§∞‡•á‡§Ç</p>
            <small>Click to select file</small>
            <input type="file" id="fileIn" accept=".csv,.xlsx" style="display:none" onchange="uploadFile(this)">
        </div>

        <!-- AI TOGGLE -->
        <div class="ai-toggle-row">
            <span>‚ö° Command</span>
            <label class="toggle-sw">
                <input type="checkbox" id="aiToggle" onchange="toggleAI(this)">
                <span class="toggle-sl"></span>
            </label>
            <span>ü§ñ AI Chat</span>
            <span class="ai-on-badge" id="aiBadge">ON</span>
        </div>

    </div>

    <!-- CHAT AREA -->
    <div class="chat-area" id="chatArea"></div>

</div>

<!-- PLUS MENU -->
<div class="plus-menu" id="plusMenu">
    <div class="plus-menu-title">üõ† Tools & Downloads</div>
    <div class="pm-grid">
        <div class="pm-item" onclick="quickCmd('dashboard');closePlus()">
            <span class="pm-icon">üìä</span>
            <span class="pm-label">Dashboard</span>
            <span class="pm-pro">Pro</span>
        </div>
        <div class="pm-item" onclick="quickCmd('kpi');closePlus()">
            <span class="pm-icon">üìà</span>
            <span class="pm-label">KPI Cards</span>
        </div>
        <div class="pm-item" onclick="quickCmd('top 5');closePlus()">
            <span class="pm-icon">üèÜ</span>
            <span class="pm-label">Top 5</span>
        </div>
        <div class="pm-item" onclick="quickCmd('bar chart');closePlus()">
            <span class="pm-icon">üìâ</span>
            <span class="pm-label">Bar Chart</span>
        </div>
        <div class="pm-item" onclick="quickCmd('export excel');closePlus()">
            <span class="pm-icon">üìÑ</span>
            <span class="pm-label">Excel</span>
            <span class="pm-pro">Pro</span>
        </div>
        <div class="pm-item" onclick="quickCmd('export csv');closePlus()">
            <span class="pm-icon">üìã</span>
            <span class="pm-label">CSV</span>
        </div>
        <div class="pm-item" onclick="quickCmd('export html');closePlus()">
            <span class="pm-icon">üåê</span>
            <span class="pm-label">HTML</span>
        </div>
        <div class="pm-item" onclick="quickCmd('average');closePlus()">
            <span class="pm-icon">üî¢</span>
            <span class="pm-label">Average</span>
        </div>
    </div>

    <!-- Voice settings inside plus -->
    <div class="pm-voice-row">
        <label>üîä</label>
        <button class="gender-btn active" id="btnF" onclick="setGender('female')">üë© Female</button>
        <button class="gender-btn" id="btnM" onclick="setGender('male')">üë® Male</button>
        <div class="speed-wrap">
            <label>Speed</label>
            <input type="range" id="spd" min="0.5" max="1.8" step="0.1" value="0.95" oninput="document.getElementById('spdVal').textContent=this.value+'x'">
            <span id="spdVal" style="font-size:10px;font-weight:700;color:var(--p)">0.95x</span>
        </div>
    </div>

    <!-- Downloads (appear when ready) -->
    <div class="dl-section" id="dlSection">
        <div class="dl-title">üì• Downloads</div>
        <div class="dl-btns">
            <button class="dl-btn" id="dlPlot" onclick="triggerDl('plot')" disabled>üìä Plot</button>
            <button class="dl-btn" id="dlDash" onclick="triggerDl('dashboard')" disabled>üìà Dashboard</button>
            <button class="dl-btn" id="dlExcel" onclick="triggerDl('excel')" disabled>üìÑ Excel</button>
            <button class="dl-btn" id="dlCSV" onclick="triggerDl('csv')" disabled>üìã CSV</button>
            <button class="dl-btn" id="dlHTML" onclick="triggerDl('html')" disabled>üåê HTML</button>
            <button class="dl-btn" onclick="dlAllReports()">üìù All Reports</button>
        </div>
        <button class="email-dl-btn" onclick="document.getElementById('emailModal').classList.add('show');closePlus()">üìß Email Reports</button>
    </div>
</div>

<!-- INPUT BAR -->
<div class="input-bar">
    <div class="input-wrap">
        <button class="input-btn plus-btn" onclick="togglePlus()">+</button>
        <input type="text" id="msgInput" placeholder="Pehle file upload karo..." disabled>
        <button class="input-btn voice-btn" id="voiceBtn" onclick="toggleVoice()">üé§</button>
        <button class="input-btn send-btn" id="sendBtn" onclick="sendMsg()" disabled>‚û§</button>
    </div>
    <div class="voice-status" id="vStatus"></div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê FLOATING LED TV ‚ïê‚ïê‚ïê‚ïê -->
<div id="ledTv" class="led-tv">
    <div id="tvSizeLabel" style="position:absolute;top:-22px;left:50%;transform:translateX(-50%);background:rgba(91,94,244,0.9);color:white;font-size:9px;font-weight:800;padding:2px 8px;border-radius:6px;white-space:nowrap;pointer-events:none;opacity:0;transition:opacity 0.2s;z-index:10"></div>
    <div style="background:linear-gradient(180deg,#1c1c30,#0f0f1a);border-radius:10px 10px 6px 6px;border:2.5px solid #2a2a4a;box-shadow:0 0 0 1px #3a3a5a,inset 0 0 12px rgba(91,94,244,0.1);overflow:hidden;position:relative">
        <div style="position:absolute;inset:0;pointer-events:none;z-index:20;background:repeating-linear-gradient(0deg,transparent,transparent 2px,rgba(0,0,0,0.06) 2px,rgba(0,0,0,0.06) 4px);border-radius:8px"></div>
        <!-- Screen -->
        <div id="tvScreen" style="width:100%;height:90px;background:#000;overflow:hidden;position:relative">
            <div style="width:100%;height:100%;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:3px;background:linear-gradient(135deg,#0f0f1a,#1a1a2e)">
                <span style="font-size:22px">üì∫</span>
                <p style="font-size:7px;color:#4a4a7a;font-weight:700">Loading...</p>
            </div>
        </div>
        <!-- Dots + Progress -->
        <div style="background:#0d0d1f;padding:2px 5px;display:flex;align-items:center;gap:3px">
            <div id="tvDots" style="display:flex;gap:2px"></div>
            <div style="flex:1;height:2px;background:#1a1a3a;border-radius:2px;overflow:hidden">
                <div id="tvProgFill" style="height:100%;background:linear-gradient(90deg,#5b5ef4,#8b5cf6);border-radius:2px;width:0%;transition:width linear"></div>
            </div>
        </div>

        <!-- ‚ïê‚ïê BUILT-IN REMOTE CONTROLS ‚ïê‚ïê -->
        <div style="background:#060612;padding:4px 5px 5px;border-top:1px solid #1a1a3a">

            <!-- Row 1: Now Playing info -->
            <div style="display:flex;align-items:center;gap:4px;margin-bottom:3px">
                <div style="width:14px;height:14px;border-radius:3px;background:linear-gradient(135deg,#5b5ef4,#8b5cf6);display:flex;align-items:center;justify-content:center;font-size:7px;flex-shrink:0">üéµ</div>
                <div id="tvMusicTitle" style="flex:1;font-size:6.5px;font-weight:800;color:#e0e0ff;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">No songs</div>
                <span id="tvStatus" style="font-size:6px;font-weight:700;color:#4a4a7a;flex-shrink:0">üì∫ Posts</span>
            </div>

            <!-- Row 2: Playback controls -->
            <div style="display:flex;align-items:center;gap:3px;margin-bottom:3px">
                <button onclick="tvPrev()" style="flex:1;background:#1e1e38;border:1px solid #3a3a5a;border-radius:5px;color:#8890a4;cursor:pointer;font-size:13px;padding:3px 0;line-height:1;transition:0.1s" ontouchstart="this.style.background='#2a2a5a'" ontouchend="this.style.background='#1e1e38'">‚èÆ</button>
                <button id="tvPlayBtn" onclick="tvTogglePlay()" style="flex:2;background:linear-gradient(135deg,#5b5ef4,#8b5cf6);border:none;border-radius:6px;color:white;cursor:pointer;font-size:14px;padding:4px 0;line-height:1;transition:0.1s">‚ñ∂</button>
                <button onclick="tvNext()" style="flex:1;background:#1e1e38;border:1px solid #3a3a5a;border-radius:5px;color:#8890a4;cursor:pointer;font-size:13px;padding:3px 0;line-height:1;transition:0.1s" ontouchstart="this.style.background='#2a2a5a'" ontouchend="this.style.background='#1e1e38'">‚è≠</button>
                <button id="tvMuteBtn" onclick="tvMuteToggle()" style="flex:1;background:#1e1e38;border:1px solid #3a3a5a;border-radius:5px;color:#8890a4;cursor:pointer;font-size:11px;padding:3px 0;line-height:1;transition:0.1s">üîä</button>
            </div>

            <!-- Row 3: Volume + Speed -->
            <div style="display:flex;align-items:center;gap:3px;margin-bottom:3px">
                <!-- Volume -->
                <button onclick="tvVolChange(-0.1)" style="background:#1e1e38;border:1px solid #3a3a5a;border-radius:4px;color:#8890a4;cursor:pointer;font-size:12px;width:20px;height:18px;line-height:1;flex-shrink:0">‚àí</button>
                <div id="tvVolDisp" style="width:28px;text-align:center;font-size:7px;font-weight:800;color:#5b5ef4;background:#0f0f1a;border-radius:4px;padding:3px 0;flex-shrink:0">80%</div>
                <button onclick="tvVolChange(0.1)" style="background:#1e1e38;border:1px solid #3a3a5a;border-radius:4px;color:#8890a4;cursor:pointer;font-size:12px;width:20px;height:18px;line-height:1;flex-shrink:0">+</button>
                <div style="width:1px;height:14px;background:#2a2a4a;flex-shrink:0"></div>
                <!-- Speed -->
                <button onclick="tvSpeedChange(-1)" style="background:#1e1e38;border:1px solid #3a3a5a;border-radius:4px;color:#8890a4;cursor:pointer;font-size:9px;width:18px;height:18px;line-height:1;font-weight:900;flex-shrink:0">‚àí</button>
                <div id="tvSpdDisp" style="width:24px;text-align:center;font-size:7px;font-weight:800;color:#06d6a0;background:#0f0f1a;border-radius:4px;padding:3px 0;flex-shrink:0">1x</div>
                <button onclick="tvSpeedChange(1)" style="background:#1e1e38;border:1px solid #3a3a5a;border-radius:4px;color:#8890a4;cursor:pointer;font-size:9px;width:18px;height:18px;line-height:1;font-weight:900;flex-shrink:0">+</button>
                <div style="width:1px;height:14px;background:#2a2a4a;flex-shrink:0"></div>
                <!-- Quality -->
                <button id="tvQualBtn" onclick="tvQualToggle()" style="flex:1;background:#1e1e38;border:1px solid #3a3a5a;border-radius:4px;color:#8890a4;cursor:pointer;font-size:6.5px;font-weight:800;padding:3px 2px;line-height:1;font-family:'DM Sans',sans-serif">üì∫HQ</button>
            </div>

            <!-- Row 4: Brightness + Edit + Drag handle -->
            <div style="display:flex;align-items:center;gap:3px">
                <span style="font-size:6px;color:#4a4a7a;flex-shrink:0">üîÜ</span>
                <div id="tvBrightTrack" onclick="tvBrightSet(event)" style="flex:1;height:5px;background:#1a1a3a;border-radius:3px;cursor:pointer;overflow:hidden">
                    <div id="tvBrightFill" style="height:100%;background:linear-gradient(90deg,#f59e0b,#fbbf24);width:80%;border-radius:3px;pointer-events:none"></div>
                </div>
                <button id="tvEditBtn" onclick="tvAdminPanel(event)" style="display:none;background:#1e1e38;border:1px solid #3a3a5a;border-radius:4px;color:#5b5ef4;cursor:pointer;font-size:11px;padding:2px 4px;line-height:1;flex-shrink:0">‚úèÔ∏è</button>
                <button onclick="tvCollapse(event)" id="tvColBtn" style="background:#1e1e38;border:1px solid #3a3a5a;border-radius:4px;color:#4a4a7a;cursor:pointer;font-size:9px;padding:2px 5px;line-height:1;flex-shrink:0">‚ñº</button>
            </div>
        </div>

        <!-- Drag handle bar -->
        <div id="tvToolbar" style="background:#030308;padding:2px 6px;display:flex;align-items:center;justify-content:center;cursor:grab">
            <span style="font-size:8px;color:#2a2a4a;letter-spacing:3px">‚†ø‚†ø‚†ø</span>
        </div>

        <!-- Resize handle -->
        <div id="tvResize" style="position:absolute;bottom:0;right:0;width:18px;height:18px;cursor:se-resize;z-index:30;display:flex;align-items:center;justify-content:center">
            <svg width="10" height="10" viewBox="0 0 10 10"><path d="M1 9L9 1M5 9L9 5" stroke="#5b5ef4" stroke-width="2" stroke-linecap="round"/></svg>
        </div>
    </div>
    <div style="width:16px;height:5px;background:#1a1a2e;margin:0 auto"></div>
    <div style="width:44px;height:4px;background:#1a1a2e;margin:0 auto;border-radius:0 0 4px 4px"></div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê ADMIN EDITOR PANEL ‚ïê‚ïê‚ïê‚ïê -->
<div class="tap-wrap" id="tapWrap">
    <div style="padding:11px 14px;background:linear-gradient(135deg,#5b5ef4,#8b5cf6);border-radius:15px 15px 0 0;display:flex;align-items:center;justify-content:space-between">
        <h4 style="font-size:13px;font-weight:800;color:white">‚úèÔ∏è Screen Editor</h4>
        <button onclick="tvAdminPanel()" style="background:rgba(255,255,255,0.2);border:none;border-radius:8px;color:white;cursor:pointer;font-size:14px;padding:2px 7px">‚úï</button>
    </div>
    <div style="padding:12px">
        <div id="tapMsg" style="font-size:10px;font-weight:700;padding:5px 8px;border-radius:6px;margin-bottom:6px;display:none"></div>
        <div style="display:flex;gap:5px;margin-bottom:10px">
            <button id="tTab1" onclick="tSwitch(1)" style="flex:1;padding:6px;border-radius:8px;border:1.5px solid #5b5ef4;cursor:pointer;font-size:10px;font-weight:800;background:linear-gradient(135deg,#5b5ef4,#8b5cf6);color:white;font-family:'DM Sans',sans-serif">üì¢ Posts</button>
            <button id="tTab2" onclick="tSwitch(2)" style="flex:1;padding:6px;border-radius:8px;border:1.5px solid #e8eaf0;cursor:pointer;font-size:10px;font-weight:800;background:white;color:#1a1a2e;font-family:'DM Sans',sans-serif">üéµ Music</button>
            <button id="tTab3" onclick="tSwitch(3)" style="flex:1;padding:6px;border-radius:8px;border:1.5px solid #e8eaf0;cursor:pointer;font-size:10px;font-weight:800;background:white;color:#1a1a2e;font-family:'DM Sans',sans-serif">üé¨ Video</button>
        </div>
        <!-- Posts -->
        <div id="tPanel1">
            <div style="display:flex;gap:5px;margin-bottom:7px">
                <button id="tTypeTxt" onclick="tType('text')" style="flex:1;padding:5px;border-radius:7px;border:1.5px solid #5b5ef4;background:linear-gradient(135deg,#5b5ef4,#8b5cf6);color:white;cursor:pointer;font-size:10px;font-weight:700;font-family:'DM Sans',sans-serif">üìù Text</button>
                <button id="tTypeImg" onclick="tType('image')" style="flex:1;padding:5px;border-radius:7px;border:1.5px solid #e8eaf0;background:white;cursor:pointer;font-size:10px;font-weight:700;font-family:'DM Sans',sans-serif">üñºÔ∏è Image</button>
            </div>
            <input type="hidden" id="tPostType" value="text">
            <input class="tap-inp" type="text" id="tTitle" placeholder="Title">
            <textarea class="tap-inp" id="tContent" rows="2" placeholder="Content..." style="resize:none"></textarea>
            <div id="tImgField" style="display:none;margin-bottom:7px">
                <input type="file" id="tImage" accept="image/*" style="width:100%;padding:7px;border:1.5px dashed #5b5ef4;border-radius:8px;font-size:10px;background:#f8f8ff;cursor:pointer;box-sizing:border-box">
                <small style="font-size:9px;color:#888;display:block;margin-top:2px">‚úÖ GIF bhi chalega!</small>
            </div>
            <input class="tap-inp" type="url" id="tAff" placeholder="üîó Affiliate URL (optional)">
            <button class="tap-btn-main" onclick="tAddPost()">‚ûï Add Post</button>
            <div id="tPostList"></div>
        </div>
        <!-- Music -->
        <div id="tPanel2" style="display:none">
            <input class="tap-inp" type="text" id="tSongTitle" placeholder="Song title">
            <input class="tap-inp" type="text" id="tSongArtist" placeholder="Artist name">
            <input type="file" id="tSongFile" accept="audio/*,.mp3,.wav" style="width:100%;padding:7px;border:1.5px dashed #5b5ef4;border-radius:8px;font-size:10px;background:#f8f8ff;cursor:pointer;box-sizing:border-box;margin-bottom:5px">
            <small style="font-size:9px;color:#888;display:block;margin-bottom:8px">MP3/WAV ‚Äî Max 10MB</small>
            <button class="tap-btn-main" onclick="tUploadSong()">üéµ Upload Song</button>
            <div id="tSongList"></div>
        </div>
        <!-- Video -->
        <div id="tPanel3" style="display:none">
            <input class="tap-inp" type="text" id="tVideoTitle" placeholder="Video title">
            <input class="tap-inp" type="text" id="tVideoDesc" placeholder="Description (optional)">
            <input type="file" id="tVideoFile" accept="video/*,.mp4,.webm,.mov" style="width:100%;padding:7px;border:1.5px dashed #5b5ef4;border-radius:8px;font-size:10px;background:#f8f8ff;cursor:pointer;box-sizing:border-box;margin-bottom:4px">
            <small style="font-size:9px;color:#888;display:block;margin-bottom:8px">MP4/WebM ‚Äî Max 10MB</small>
            <button class="tap-btn-main" onclick="tUploadVideo()">üé¨ Upload Video</button>
            <div id="tVideoList"></div>
        </div>
    </div>
</div>

<audio id="tvAudio" preload="metadata"></audio>

<!-- EMAIL MODAL -->
<div class="modal" id="emailModal">
    <div class="modal-card">
        <h3>üìß Send Report</h3>
        <input type="email" id="emailInput" placeholder="Client ka email">
        <div class="modal-btns">
            <button class="m-send" onclick="sendReport()">Send</button>
            <button class="m-cancel" onclick="document.getElementById('emailModal').classList.remove('show')">Cancel</button>
        </div>
    </div>
</div>

<!-- VIEWER -->
<div class="viewer-modal" id="viewerModal">
    <div class="viewer-content">
        <span class="v-close" onclick="closeViewer()">&times;</span>
        <div id="viewerBox"></div>
    </div>
</div>

<script>
// ‚ïê‚ïê STATE ‚ïê‚ïê
let fileReady=false, processing=false, aiMode=false;
let history=[], plotR=false, dashR=false, excelR=false, csvR=false, htmlR=false;
let recog=null, listening=false, voiceGender='female';
let affiliates=[], pendingDl=null, bubbleTimer=null;
let plan='free';

// ‚ïê‚ïê REACTIONS ‚ïê‚ïê
const RX={
    success:{e:'üéâ',l:'Woohoo!',a:'celebrate'},happy:{e:'üòä',l:'Nice!',a:''},
    excited:{e:'ü§©',l:'Amazing!',a:'celebrate'},thinking:{e:'ü§î',l:'Hmm...',a:'think'},
    data:{e:'üìä',l:'Data!',a:''},error:{e:'üòÖ',l:'Oops!',a:'shake'},
    chart:{e:'üìà',l:'Chart!',a:'celebrate'},save:{e:'üíæ',l:'Saved!',a:''},
    hi:{e:'üëã',l:'Hello!',a:''},tip:{e:'üí°',l:'Tip!',a:''},
    pro:{e:'‚≠ê',l:'Pro!',a:''}
};
function getRx(t){
    const s=t.toLowerCase();
    if(s.includes('‚úÖ')||s.includes('success')||s.includes('saved'))return RX.success;
    if(s.includes('‚≠ê')||s.includes('pro plan')||s.includes('upgrade'))return RX.pro;
    if(s.includes('dashboard'))return RX.chart;
    if(s.includes('‚ùå')||s.includes('error')||s.includes('‚ö†Ô∏è'))return RX.error;
    if(s.includes('chart')||s.includes('plot')||s.includes('graph'))return RX.chart;
    if(s.includes('excel')||s.includes('csv')||s.includes('export'))return RX.save;
    if(s.includes('total')||s.includes('average')||s.includes('üìä'))return RX.data;
    if(s.includes('üí°'))return RX.tip;
    if(s.includes('hello')||s.includes('namaste')||s.includes('hi'))return RX.hi;
    return RX.happy;
}

// ‚ïê‚ïê MASCOT ‚ïê‚ïê
function initMascot(){
    lottie.loadAnimation({container:document.getElementById('lottie-bot'),renderer:'svg',loop:true,autoplay:true,
        path:'https://assets9.lottiefiles.com/packages/lf20_qp1q7mct.json'
    }).addEventListener('data_failed',()=>{
        document.getElementById('lottie-bot').innerHTML='<div style="font-size:80px;text-align:center;line-height:120px;animation:bob 2s ease-in-out infinite">ü§ñ</div>';
        const s=document.createElement('style');s.textContent='@keyframes bob{0%,100%{transform:translateY(0)}50%{transform:translateY(-12px)}}';document.head.appendChild(s);
    });
    setTimeout(()=>bubble('Data upload karo! üöÄ'),1500);
}
function bubble(text){
    const b=document.getElementById('bubble');
    b.textContent=text; b.classList.add('show');
    clearTimeout(bubbleTimer);
    bubbleTimer=setTimeout(()=>b.classList.remove('show'),3000);
}
function mascotTap(){
    const msgs=['Kya analysis karni hai? ü§î','Mera naam DS Agent hai! üòÑ','Dashboard try karo! üìä','AI Mode try karo üß†','Main ready hoon! üí™'];
    bubble(msgs[Math.floor(Math.random()*msgs.length)]);
}

// ‚ïê‚ïê DRAWER ‚ïê‚ïê
function openDrawer(){document.getElementById('drawer').classList.add('open');document.getElementById('overlay').classList.add('show');}
function closeDrawer(){document.getElementById('drawer').classList.remove('open');document.getElementById('overlay').classList.remove('show');}
function openDrawerAffiliate(){closeDrawer();window.location.href='/admin';}
function openDrawerUsers(){closeDrawer();window.location.href='/admin';}

// ‚ïê‚ïê PLUS MENU ‚ïê‚ïê
let plusOpen=false;
function togglePlus(){plusOpen=!plusOpen;document.getElementById('plusMenu').classList.toggle('show',plusOpen);}
function closePlus(){plusOpen=false;document.getElementById('plusMenu').classList.remove('show');}
document.addEventListener('click',e=>{if(plusOpen&&!e.target.closest('#plusMenu')&&!e.target.closest('.plus-btn'))closePlus();});

// ‚ïê‚ïê VOICE GENDER ‚ïê‚ïê
function setGender(g){
    voiceGender=g;
    document.getElementById('btnF').className='gender-btn'+(g==='female'?' active':'');
    document.getElementById('btnM').className='gender-btn'+(g==='male'?' active':'');
    speak(g==='female'?'Main hun aapki female assistant!':'Main hun aapka male assistant!');
}

// ‚ïê‚ïê SPEAK ‚ïê‚ïê
function speak(text){
    if(!window.speechSynthesis)return;
    window.speechSynthesis.cancel();
    const clean=text.replace(/[^\x00-\x7F\u0900-\u097F\s]/g,'').replace(/\*\*/g,'').trim().substring(0,300);
    if(!clean)return;
    const u=new SpeechSynthesisUtterance(clean);
    u.lang='hi-IN'; u.rate=parseFloat(document.getElementById('spd').value);
    u.pitch=voiceGender==='female'?1.4:0.7; u.volume=1;
    const vs=window.speechSynthesis.getVoices();
    const hi=vs.filter(v=>v.lang.includes('hi')||v.lang.includes('IN'));
    if(hi.length) u.voice=voiceGender==='female'?(hi.find(v=>v.name.toLowerCase().includes('female'))||hi[0]):(hi.find(v=>v.name.toLowerCase().includes('male'))||hi[hi.length-1]);
    u.onstart=()=>document.getElementById('speakRow').classList.add('on');
    u.onend=()=>document.getElementById('speakRow').classList.remove('on');
    window.speechSynthesis.speak(u);
}
if(window.speechSynthesis)window.speechSynthesis.onvoiceschanged=()=>window.speechSynthesis.getVoices();

// ‚ïê‚ïê VOICE INPUT ‚ïê‚ïê
function initVoice(){
    const SR=window.SpeechRecognition||window.webkitSpeechRecognition;
    if(!SR){document.getElementById('voiceBtn').style.opacity='0.4';return;}
    recog=new SR(); recog.lang='hi-IN'; recog.continuous=false; recog.interimResults=true;
    recog.onstart=()=>{listening=true;document.getElementById('voiceBtn').classList.add('listening');document.getElementById('vStatus').textContent='üé§ Sun raha hoon...';bubble('Bol do! üëÇ');};
    recog.onresult=e=>{let t='';for(let i=e.resultIndex;i<e.results.length;i++)t+=e.results[i][0].transcript;document.getElementById('msgInput').value=t;document.getElementById('vStatus').textContent='üìù '+t;};
    recog.onend=()=>{listening=false;document.getElementById('voiceBtn').classList.remove('listening');document.getElementById('vStatus').textContent='';const v=document.getElementById('msgInput').value.trim();if(v&&fileReady)setTimeout(sendMsg,500);};
    recog.onerror=()=>{listening=false;document.getElementById('voiceBtn').classList.remove('listening');document.getElementById('vStatus').textContent='‚ö†Ô∏è Try again';setTimeout(()=>document.getElementById('vStatus').textContent='',2000);};
}
function toggleVoice(){if(!recog){alert('Chrome mein try karo!');return;}if(listening)recog.stop();else recog.start();}

// ‚ïê‚ïê INIT ‚ïê‚ïê
window.addEventListener('DOMContentLoaded',()=>{
    initMascot(); initVoice();
    fetch('/get_username').then(r=>r.json()).then(d=>{
        const name=d.username||'User'; plan=d.plan||'free';
        document.getElementById('wName').textContent=name.toUpperCase()+'! üëã';
        document.getElementById('wSub').textContent=plan==='pro'?'Pro Plan Active ‚≠ê':'‡§ï‡§π‡§æ‡§Å ‡§∏‡•á ‡§∂‡•Å‡§∞‡•Å‡§Ü‡§§ ‡§ï‡§∞‡•á‡§Ç?';
        document.getElementById('drawerName').textContent=name;
        document.getElementById('drawerSub').innerHTML=`${plan==='pro'?'Pro plan':'Free plan'} <span class="plan-pill ${plan}">${plan==='pro'?'‚≠ê Pro':'Free'}</span>`;
        document.getElementById('drawerAvatar').textContent=name.charAt(0).toUpperCase();
        document.getElementById('drawerPill').textContent=plan==='pro'?'‚≠ê Pro':'Free';
        document.getElementById('drawerPill').className='plan-pill '+plan;
        document.getElementById('topAvatar').textContent=name.charAt(0).toUpperCase();
        if(d.is_admin){document.getElementById('adminSection').style.display='block';initTV(true);}
        else{initTV(false);}
        if(plan==='free'){
            const qb=document.getElementById('queryBar'); qb.classList.add('show');
            const used=d.queries_used||0, lim=d.queries_limit||10;
            document.getElementById('qbText').textContent=`${used}/${lim} queries`;
            document.getElementById('qbFill').style.width=(used/lim*100)+'%';
        }
        setTimeout(()=>bubble('Namaste '+name+'! üòÑ'),2000);
    }).catch(()=>{
        document.getElementById('wName').textContent='USER! üëã';
        document.getElementById('drawerAvatar').textContent='U';
        document.getElementById('topAvatar').textContent='U';
    });
    fetch('/affiliate_links').then(r=>r.json()).then(d=>affiliates=d).catch(()=>{});
});

// ‚ïê‚ïê AI TOGGLE ‚ïê‚ïê
function toggleAI(cb){
    if(cb.checked&&plan!=='pro'){
        cb.checked=false;
        addMsg('‚≠ê AI Chat Mode sirf Pro plan mein!\n\nUpgrade karo: /pricing','bot');
        window.location.href='/pricing'; return;
    }
    aiMode=cb.checked;
    document.getElementById('aiBadge').className='ai-on-badge'+(aiMode?' on':'');
    document.getElementById('msgInput').placeholder=aiMode?'Seedha Hinglish mein puch lo...':"Type command or question...";
    addMsg(aiMode?'ü§ñ AI Chat Mode ON! Kuch bhi puch lo!':'‚ö° Command Mode ON!','bot');
    bubble(aiMode?'AI Mode ON! üß†':'Command Mode ‚ö°');
}

// ‚ïê‚ïê ADD MESSAGE ‚ïê‚ïê
function addMsg(text,sender){
    const area=document.getElementById('chatArea');
    const row=document.createElement('div');
    row.className='reaction-row'+(sender.includes('bot')?'':' user-row');

    if(sender.includes('bot')){
        const rx=getRx(text);
        const ch=document.createElement('span');
        ch.className='r-char'; ch.textContent=rx.e;
        // animate
        if(rx.a==='celebrate')ch.style.animation='bob 0.6s ease 3';
        if(rx.a==='shake'){ch.style.animation='shake 0.4s ease 3';}
        row.appendChild(ch);
        bubble(rx.e+' '+rx.l);
        setTimeout(()=>{if(aiMode&&text.length<200)speak(text);},300);
        history.push({t:'bot',text,ts:new Date().toLocaleString()});
    }else{history.push({t:'user',text,ts:new Date().toLocaleString()});}

    const bub=document.createElement('div');
    bub.className='r-bubble '+(sender.includes('bot')?(sender.includes('ai-mode')?'ai-mode':''):'user');
    bub.innerText=text;

    if(sender.includes('bot')){
        const acts=document.createElement('div');acts.className='r-actions';
        const d=document.createElement('button');d.className='r-action-btn';d.textContent='üíæ';d.onclick=()=>dlSingle(text);
        const s=document.createElement('button');s.className='r-action-btn';s.textContent='üîä';s.onclick=()=>speak(text);
        acts.appendChild(d);acts.appendChild(s);bub.appendChild(acts);
    }

    row.appendChild(bub);
    area.appendChild(row);
    area.scrollTop=area.scrollHeight;
}

function showTyping(){
    const area=document.getElementById('chatArea');
    const row=document.createElement('div');row.className='reaction-row';row.id='typingRow';
    const ch=document.createElement('span');ch.className='r-char';ch.textContent='ü§î';
    const bub=document.createElement('div');bub.className='r-bubble';
    bub.innerHTML='<div class="typing-dots"><span></span><span></span><span></span></div>';
    row.appendChild(ch);row.appendChild(bub);
    area.appendChild(row);area.scrollTop=area.scrollHeight;
    bubble('Soch raha hoon... ü§î');
}
function removeTyping(){const el=document.getElementById('typingRow');if(el)el.remove();}
function setInput(e){document.getElementById('msgInput').disabled=!e;document.getElementById('sendBtn').disabled=!e;}
function quickCmd(cmd){closeDrawer();document.getElementById('msgInput').value=cmd;sendMsg();}
function handleSessExp(){document.getElementById('sessOverlay').classList.add('show');}

// ‚ïê‚ïê UPLOAD ‚ïê‚ïê
function uploadFile(input){
    if(!input.files[0])return;
    const fd=new FormData();fd.append('file',input.files[0]);
    document.getElementById('uploadTxt').innerHTML='<div class="loader"></div> Syncing...';
    setInput(false);bubble('Upload ho rahi hai... ‚è≥');
    fetch('/upload',{method:'POST',body:fd})
    .then(r=>{if(r.status===401)return r.json().then(d=>{if(d.error==='SESSION_EXPIRED')handleSessExp();throw new Error('sess');});return r.json();})
    .then(d=>{
        addMsg('‚úÖ '+d.message,'bot');
        const z=document.getElementById('uploadZone');
        z.classList.add('synced');
        document.getElementById('uploadTxt').textContent='‚úÖ Synced: '+input.files[0].name;
        fileReady=true;setInput(true);
        document.getElementById('msgInput').placeholder='Kuch bhi puch lo...';
        bubble('File ready! Shuru karo! üéâ');
    })
    .catch(e=>{if(e.message==='sess')return;addMsg('‚ùå Upload failed!','bot');document.getElementById('uploadTxt').textContent='üìÅ Try Again';setInput(true);bubble('Upload fail üòÖ');});
}

// ‚ïê‚ïê SEND ‚ïê‚ïê
function sendMsg(){
    const inp=document.getElementById('msgInput');
    const msg=inp.value.trim();
    if(!msg||processing)return;
    if(!fileReady){addMsg('‚ö†Ô∏è Pehle file upload karo!','bot');return;}
    addMsg(msg,'user');inp.value='';processing=true;setInput(false);showTyping();
    fetch('/chat',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({message:msg,ai_mode:aiMode})})
    .then(r=>{if(r.status===401)return r.json().then(d=>{if(d.error==='SESSION_EXPIRED')handleSessExp();throw new Error('sess');});return r.json();})
    .then(d=>{
        removeTyping();
        addMsg(d.response,aiMode?'bot ai-mode':'bot');
        if(d.limit_reached)bubble('Query limit! Upgrade karo ‚≠ê');
        const ml=msg.toLowerCase();
        let showDl=false;
        if(['plot','chart','graph','bar','hist'].some(t=>ml.includes(t))||d.response.toLowerCase().includes('plot saved')){setTimeout(()=>{plotR=true;document.getElementById('dlPlot').disabled=false;showDl=true;showDlSection();},1500);}
        if(ml.includes('dashboard')){setTimeout(()=>{dashR=true;document.getElementById('dlDash').disabled=false;showDlSection();},2500);}
        if(['excel','xlsx'].some(t=>ml.includes(t))){setTimeout(()=>{excelR=true;document.getElementById('dlExcel').disabled=false;showDlSection();},1500);}
        if(ml.includes('csv')){setTimeout(()=>{csvR=true;document.getElementById('dlCSV').disabled=false;showDlSection();},1500);}
        if(ml.includes('html')){setTimeout(()=>{htmlR=true;document.getElementById('dlHTML').disabled=false;showDlSection();},1500);}
        processing=false;setInput(true);
    })
    .catch(e=>{if(e.message==='sess')return;removeTyping();addMsg('‚ö†Ô∏è Server slow hai.','bot');bubble('Connection issue üòÖ');processing=false;setInput(true);});
}

function showDlSection(){document.getElementById('dlSection').classList.add('show');}

// ‚ïê‚ïê AFFILIATE + DOWNLOAD ‚ïê‚ïê
function triggerDl(type){
    closePlus();
    if(affiliates.length){
        const link=affiliates[Math.floor(Math.random()*affiliates.length)];
        document.getElementById('affTitle').textContent=link.title;
        document.getElementById('affDesc').textContent=link.description||'Check out our partner!';
        document.getElementById('affLink').href=link.url;
        pendingDl=type;
        document.getElementById('affOverlay').classList.add('show');
    }else{doDl(type);}
}
function proceedDl(){document.getElementById('affOverlay').classList.remove('show');if(pendingDl){doDl(pendingDl);pendingDl=null;}}
function doDl(type){
    const m={
        plot:{r:plotR,url:'/plot.png',name:'plot_'+Date.now()+'.png',msg:'Pehle chart banao!'},
        dashboard:{r:dashR,url:'/dashboard.png',name:'dashboard_'+Date.now()+'.png',msg:'Pehle dashboard banao!'},
        excel:{r:excelR,url:'/download/excel',name:'report_'+Date.now()+'.xlsx',msg:'"export excel" command do!'},
        csv:{r:csvR,url:'/download/csv',name:'data_'+Date.now()+'.csv',msg:'"export csv" command do!'},
        html:{r:htmlR,url:'/download/html',name:'report_'+Date.now()+'.html',msg:'"export html" command do!'}
    };
    const item=m[type];if(!item)return;
    if(!item.r){alert(item.msg);return;}
    const a=document.createElement('a');a.href=item.url+'?t='+Date.now();a.download=item.name;document.body.appendChild(a);a.click();document.body.removeChild(a);
}
function dlSingle(text){const blob=new Blob([text],{type:'text/plain'});const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download='response_'+Date.now()+'.txt';document.body.appendChild(a);a.click();document.body.removeChild(a);URL.revokeObjectURL(url);}
function dlAllReports(){if(!history.length){alert('No history!');return;}let c='ü§ñ DS Agent Report\n'+'='.repeat(40)+'\n'+new Date().toLocaleString()+'\n\n';history.forEach(m=>{c+=`[${m.ts}] ${m.t==='user'?'üë§ You':'ü§ñ Bot'}:\n${m.text}\n\n`+'-'.repeat(40)+'\n\n';});const blob=new Blob([c],{type:'text/plain'});const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download='report_'+Date.now()+'.txt';document.body.appendChild(a);a.click();document.body.removeChild(a);URL.revokeObjectURL(url);}

function sendReport(){const email=document.getElementById('emailInput').value;if(!email){alert('Email enter karo');return;}fetch('/send_report',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({email})}).then(r=>r.json()).then(d=>{alert(d.message||d.error);if(d.message)document.getElementById('emailModal').classList.remove('show');}).catch(()=>alert('Error'));}

function closeViewer(){document.getElementById('viewerModal').classList.remove('show');document.getElementById('viewerBox').innerHTML='';}
document.getElementById('viewerModal').addEventListener('click',e=>{if(e.target===document.getElementById('viewerModal'))closeViewer();});
document.getElementById('msgInput').addEventListener('keypress',e=>{if(e.key==='Enter'&&!e.target.disabled)sendMsg();});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// FLOATING LED TV + REMOTE  ‚Äî  Full Featured
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const tvAudio=document.getElementById('tvAudio');
const ledTv=document.getElementById('ledTv');
const tvScreen=document.getElementById('tvScreen');
const TV_MS=6000;
const SPEEDS=[0.5,0.75,1,1.25,1.5,2];

// State
let tvPosts=[],tvCur=0,tvTimer=null,tvCollapsed=false;
let tvTracks=[],tvCurTrack=0,tvPlaying=false;
let tvVideos=[],tvCurVideo=0;
let tvChannel='posts'; // 'posts'|'video'|'music'
let isAdmin=false,tapOpen=false,tPostType='text';
let rVolVal=0.8,rSpdIdx=2,rMuted=false,rHQ=true,rBrightVal=80;

// ‚îÄ‚îÄ TV DRAG ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
(function(){
    let drag=false,sx=0,sy=0,sl=0,st=0;
    function start(e){
        if(e.target.closest('#tvResize')||e.target.tagName==='BUTTON')return;
        drag=true; ledTv.style.cursor='grabbing';
        const r=ledTv.getBoundingClientRect();
        sl=r.left;st=r.top;
        sx=e.touches?e.touches[0].clientX:e.clientX;
        sy=e.touches?e.touches[0].clientY:e.clientY;
        ledTv.style.right='auto';ledTv.style.bottom='auto';
        ledTv.style.left=sl+'px';ledTv.style.top=st+'px';
        e.preventDefault();
    }
    function move(e){
        if(!drag)return;
        const cx=e.touches?e.touches[0].clientX:e.clientX;
        const cy=e.touches?e.touches[0].clientY:e.clientY;
        ledTv.style.left=Math.max(0,Math.min(window.innerWidth-ledTv.offsetWidth,sl+(cx-sx)))+'px';
        ledTv.style.top=Math.max(0,Math.min(window.innerHeight-ledTv.offsetHeight,st+(cy-sy)))+'px';
        e.preventDefault();
    }
    function end(){drag=false;ledTv.style.cursor='grab';try{localStorage.setItem('tvPos',JSON.stringify({l:ledTv.style.left,t:ledTv.style.top}));}catch(e){}}
    ledTv.addEventListener('mousedown',start,{passive:false});
    ledTv.addEventListener('touchstart',start,{passive:false});
    window.addEventListener('mousemove',move,{passive:false});
    window.addEventListener('touchmove',move,{passive:false});
    window.addEventListener('mouseup',end);window.addEventListener('touchend',end);
    try{const p=JSON.parse(localStorage.getItem('tvPos'));
        if(p){
            // Validate position is on screen
            const pl=parseInt(p.l),pt=parseInt(p.t);
            if(pl>=0&&pl<window.innerWidth-50&&pt>=0&&pt<window.innerHeight-50){
                ledTv.style.right='auto';ledTv.style.bottom='auto';
                ledTv.style.left=p.l;ledTv.style.top=p.t;
            }
        }
    }catch(e){}
})();

// ‚îÄ‚îÄ TV RESIZE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
(function(){
    const h=document.getElementById('tvResize');
    const lb=document.getElementById('tvSizeLabel');
    let resizing=false,sx=0,sw=0;
    h.addEventListener('mousedown',e=>{resizing=true;sx=e.clientX;sw=ledTv.offsetWidth;lb.style.opacity='1';e.preventDefault();e.stopPropagation();});
    h.addEventListener('touchstart',e=>{resizing=true;sx=e.touches[0].clientX;sw=ledTv.offsetWidth;lb.style.opacity='1';e.preventDefault();e.stopPropagation();},{passive:false});
    window.addEventListener('mousemove',e=>{
        if(!resizing)return;
        const nw=Math.max(90,Math.min(280,sw+(e.clientX-sx)));
        ledTv.style.width=nw+'px';
        const sh=Math.round(nw*0.64);
        tvScreen.style.height=sh+'px';
        lb.textContent=nw+'√ó'+sh;
        try{localStorage.setItem('tvSize',JSON.stringify({w:nw,sh}));}catch(e){}
    });
    window.addEventListener('touchmove',e=>{
        if(!resizing)return;
        const nw=Math.max(90,Math.min(280,sw+(e.touches[0].clientX-sx)));
        ledTv.style.width=nw+'px';tvScreen.style.height=Math.round(nw*0.64)+'px';
    },{passive:false});
    window.addEventListener('mouseup',()=>{if(resizing){resizing=false;lb.style.opacity='0';}});
    window.addEventListener('touchend',()=>{if(resizing){resizing=false;lb.style.opacity='0';}});
    try{const s=JSON.parse(localStorage.getItem('tvSize'));if(s){ledTv.style.width=s.w+'px';tvScreen.style.height=s.sh+'px';}}catch(e){}
})();

// ‚îÄ‚îÄ REMOTE DRAG ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
(function(){
    const rem=document.getElementById('tvRemote');
    let drag=false,sx=0,sy=0,sl=0,st=0;
    function start(e){
        if(e.target.closest('#remoteResize'))return;
        drag=true;rem.style.cursor='grabbing';
        const r=rem.getBoundingClientRect();sl=r.left;st=r.top;
        sx=e.touches?e.touches[0].clientX:e.clientX;
        sy=e.touches?e.touches[0].clientY:e.clientY;
        rem.style.right='auto';rem.style.bottom='auto';rem.style.left=sl+'px';rem.style.top=st+'px';
        e.preventDefault();
    }
    function move(e){
        if(!drag)return;
        const cx=e.touches?e.touches[0].clientX:e.clientX;
        const cy=e.touches?e.touches[0].clientY:e.clientY;
        rem.style.left=Math.max(0,Math.min(window.innerWidth-rem.offsetWidth,sl+(cx-sx)))+'px';
        rem.style.top=Math.max(0,Math.min(window.innerHeight-rem.offsetHeight,st+(cy-sy)))+'px';
        e.preventDefault();
    }
    function end(){drag=false;rem.style.cursor='grab';}
    rem.addEventListener('mousedown',start,{passive:false});
    rem.addEventListener('touchstart',start,{passive:false});
    window.addEventListener('mousemove',move,{passive:false});
    window.addEventListener('touchmove',move,{passive:false});
    window.addEventListener('mouseup',end);window.addEventListener('touchend',end);
})();

// ‚îÄ‚îÄ REMOTE RESIZE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
(function(){
    const h=document.getElementById('remoteResize');
    const rem=document.getElementById('tvRemote');
    let resizing=false,sx=0,sw=0;
    h.addEventListener('mousedown',e=>{resizing=true;sx=e.clientX;sw=rem.offsetWidth;e.preventDefault();e.stopPropagation();});
    h.addEventListener('touchstart',e=>{resizing=true;sx=e.touches[0].clientX;sw=rem.offsetWidth;e.preventDefault();e.stopPropagation();},{passive:false});
    window.addEventListener('mousemove',e=>{if(!resizing)return;rem.style.width=Math.max(52,Math.min(110,sw+(e.clientX-sx)))+'px';});
    window.addEventListener('touchmove',e=>{if(!resizing)return;rem.style.width=Math.max(52,Math.min(110,sw+(e.touches[0].clientX-sx)))+'px';},{passive:false});
    window.addEventListener('mouseup',()=>resizing=false);
    window.addEventListener('touchend',()=>resizing=false);
})();

// ‚îÄ‚îÄ REMOTE TOGGLE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let remVisible=true;
function tvRemoteToggle(){
    remVisible=!remVisible;
    document.getElementById('tvRemote').classList.toggle('hidden',!remVisible);
    document.getElementById('remoteToggleBtn').textContent=remVisible?'üéÆ Hide':'üéÆ Remote';
}

// Position remote near TV
function posRemote(){
    const tr=ledTv.getBoundingClientRect();
    const rem=document.getElementById('tvRemote');
    const tb=document.getElementById('remoteToggleBtn');
    let l=tr.left-rem.offsetWidth-8;
    if(l<4)l=tr.right+8;
    rem.style.left=l+'px';rem.style.top=tr.top+'px';
    rem.style.right='auto';rem.style.bottom='auto';
    tb.style.left=(l+6)+'px';tb.style.top=(tr.bottom-26)+'px';
    tb.style.right='auto';tb.style.bottom='auto';
}

// ‚îÄ‚îÄ COLLAPSE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function tvCollapse(e){
    if(e)e.stopPropagation();
    tvCollapsed=!tvCollapsed;
    const body=ledTv.querySelector('[style*="background:linear-gradient(180deg,#1c1c30"]');
    if(tvCollapsed){
        ledTv.style.overflow='hidden';
        tvScreen.style.display='none';
        document.getElementById('tvColBtn').textContent='‚ñ≤';
        clearTimeout(tvTimer);
    }else{
        tvScreen.style.display='block';
        document.getElementById('tvColBtn').textContent='‚ñº';
        tvSetChannel(tvChannel);
    }
}

// ‚îÄ‚îÄ CHANNEL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const CH_IDS={posts:'chPosts',video:'chVideo',music:'chMusic'};
function tvSetChannel(ch){
    tvChannel=ch;
    Object.entries(CH_IDS).forEach(([c,id])=>{
        const b=document.getElementById(id);
        if(b){b.style.background=c===ch?'#5b5ef4':'#1e1e38';b.style.color=c===ch?'white':'#8890a4';}
    });
    clearTimeout(tvTimer);
    if(ch==='posts'){
        document.getElementById('tvStatus').textContent='üì¢ Posts';
        tvRenderPosts(); if(tvPosts.length>1)tvAutoStart();
    } else if(ch==='video'){
        document.getElementById('tvStatus').textContent='üé¨ Video';
        tvRenderVideo();
    } else {
        document.getElementById('tvStatus').textContent='üéµ Music';
        tvRenderMusicViz();
    }
}

const CHANNELS=['posts','video','music'];
function tvChPrev(){const i=CHANNELS.indexOf(tvChannel);tvSetChannel(CHANNELS[(i-1+3)%3]);}
function tvChNext(){const i=CHANNELS.indexOf(tvChannel);tvSetChannel(CHANNELS[(i+1)%3]);}

// ‚îÄ‚îÄ POSTS CHANNEL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function tvLoadPosts(){
    try{const r=await fetch('/api/screen/posts');tvPosts=await r.json();tvRenderPosts();if(tvPosts.length>1)tvAutoStart();}
    catch(e){tvEmpty('üì¢','Posts nahi');}
}
function tvRenderPosts(){
    if(!tvPosts.length){tvEmpty('üì¢','Koi post nahi');return;}
    tvScreen.innerHTML=tvPosts.map((p,i)=>`
        <div id="tvp${i}" style="display:${i===0?'flex':'none'};flex-direction:column;width:100%;height:100%;position:absolute;top:0;left:0;animation:${i===0?'tvsl .35s ease':'none'}">
            ${p.post_type==='image'&&p.image_data
                ?`<img src="data:${p.image_mime};base64,${p.image_data}" style="width:100%;height:100%;object-fit:cover">${p.affiliate_url?`<a href="${p.affiliate_url}" target="_blank" style="position:absolute;bottom:3px;left:3px;right:3px;display:block;text-align:center;padding:3px;background:linear-gradient(135deg,#5b5ef4,#8b5cf6);color:white;border-radius:4px;font-size:7px;font-weight:800;text-decoration:none">üîó Check it out</a>`:''}`
                :`<div style="width:100%;height:100%;padding:7px;display:flex;flex-direction:column;justify-content:space-between;background:linear-gradient(135deg,#0f0f1a,#1a1a2e)">
                    <div><div style="font-size:9px;font-weight:800;background:linear-gradient(135deg,#fff,#c4b5fd);-webkit-background-clip:text;-webkit-text-fill-color:transparent">${p.title}</div>
                    <div style="font-size:7.5px;color:#8890a4;margin-top:3px;overflow:hidden;display:-webkit-box;-webkit-line-clamp:3;-webkit-box-orient:vertical">${(p.content||'').replace(/\n/g,' ')}</div></div>
                    ${p.affiliate_url?`<a href="${p.affiliate_url}" target="_blank" style="display:block;text-align:center;padding:3px;background:linear-gradient(135deg,#5b5ef4,#8b5cf6);color:white;border-radius:4px;font-size:7px;font-weight:800;text-decoration:none">üîó Check it out</a>`:''}
                </div>`}
        </div>`).join('');
    document.getElementById('tvDots').innerHTML=tvPosts.map((_,i)=>
        `<div onclick="tvGo(${i})" style="width:4px;height:4px;border-radius:50%;background:${i===0?'#5b5ef4':'#2a2a4a'};cursor:pointer;flex-shrink:0;transition:0.2s" id="tvd${i}"></div>`).join('');
    document.getElementById('tvStatus').textContent='üì¢ '+tvPosts.length+' posts';
}
function tvGo(idx){
    for(let i=0;i<tvPosts.length;i++){
        const e=document.getElementById('tvp'+i); if(e)e.style.display=i===idx?'flex':'none';
        const d=document.getElementById('tvd'+i); if(d)d.style.background=i===idx?'#5b5ef4':'#2a2a4a';
    }
    tvCur=idx; tvProgReset();
}
function tvAutoStart(){tvProgReset();}
function tvProgReset(){
    const f=document.getElementById('tvProgFill');
    f.style.transition='none';f.style.width='0%';clearTimeout(tvTimer);
    setTimeout(()=>{f.style.transition=`width ${TV_MS}ms linear`;f.style.width='100%';tvTimer=setTimeout(()=>tvGo((tvCur+1)%tvPosts.length),TV_MS);},50);
}
function tvEmpty(icon,txt){
    tvScreen.innerHTML=`<div style="width:100%;height:100%;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:3px;background:linear-gradient(135deg,#0f0f1a,#1a1a2e)"><span style="font-size:22px">${icon}</span><p style="font-size:7px;color:#4a4a7a;font-weight:700">${txt}</p></div>`;
    document.getElementById('tvDots').innerHTML='';
}

// ‚îÄ‚îÄ VIDEO CHANNEL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function tvLoadVideos(){
    try{const r=await fetch('/api/video');tvVideos=await r.json();}catch(e){tvVideos=[];}
}
function tvRenderVideo(){
    document.getElementById('tvDots').innerHTML='';
    if(!tvVideos.length){tvScreen.innerHTML=`<div style="width:100%;height:100%;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:3px;background:#0a0a18"><span style="font-size:22px">üé¨</span><p style="font-size:7px;color:#4a4a7a;font-weight:700">Admin se video upload karo</p></div>`;return;}
    const v=tvVideos[tvCurVideo];
    tvScreen.innerHTML=`
        <video id="tvVid" style="width:100%;height:100%;object-fit:contain;background:#000"
            src="data:${v.mime_type};base64,${v.video_data}" playsinline></video>
        <div style="position:absolute;bottom:2px;left:3px;right:3px;background:rgba(0,0,0,0.7);border-radius:3px;padding:2px 5px">
            <div style="font-size:7px;font-weight:800;color:#fff;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${v.title}</div>
        </div>`;
    const vel=document.getElementById('tvVid');
    vel.volume=rVolVal; vel.muted=rMuted; vel.playbackRate=SPEEDS[rSpdIdx];
    vel.addEventListener('ended',()=>tvGoVid((tvCurVideo+1)%tvVideos.length));
    document.getElementById('tvDots').innerHTML=tvVideos.map((_,i)=>
        `<div onclick="tvGoVid(${i})" style="width:4px;height:4px;border-radius:50%;background:${i===tvCurVideo?'#5b5ef4':'#2a2a4a'};cursor:pointer;flex-shrink:0" id="tvvd${i}"></div>`).join('');
    tvPlaying=false; document.getElementById('tvPlayBtn').textContent='‚ñ∂';
}
function tvGoVid(idx){tvCurVideo=idx;tvRenderVideo();}

// ‚îÄ‚îÄ MUSIC CHANNEL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function tvLoadMusic(){
    try{const r=await fetch('/api/music');tvTracks=await r.json();if(tvTracks.length)tvLoadTrack(0,false);}catch(e){}
}
function tvLoadTrack(idx,play){
    if(!tvTracks[idx])return; tvCurTrack=idx;
    const t=tvTracks[idx];
    document.getElementById('tvMusicTitle').textContent=t.title;
    tvAudio.src=`data:${t.mime_type};base64,${t.audio_data}`;
    tvAudio.load(); tvAudio.volume=rVolVal; tvAudio.muted=rMuted; tvAudio.playbackRate=SPEEDS[rSpdIdx];
    if(play)tvAudio.play().then(()=>tvSetPlay(true)).catch(()=>{});
    else tvSetPlay(false);
    if(tvChannel==='music')tvRenderMusicViz();
}
function tvRenderMusicViz(){
    const t=tvTracks[tvCurTrack];
    tvScreen.innerHTML=`<div style="width:100%;height:100%;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:4px;background:linear-gradient(135deg,#0a0a18,#1a1a2e)">
        <div style="width:40px;height:40px;border-radius:50%;background:linear-gradient(135deg,#5b5ef4,#8b5cf6);display:flex;align-items:center;justify-content:center;font-size:16px">üéµ</div>
        <div style="font-size:8px;font-weight:800;color:#fff;max-width:90%;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;text-align:center">${t?t.title:'No songs'}</div>
        <div style="font-size:7px;color:#8890a4">${t?t.artist||'Unknown':''}</div>
    </div>`;
    document.getElementById('tvDots').innerHTML='';
}
function tvSetPlay(v){tvPlaying=v;document.getElementById('tvPlayBtn').textContent=v?'‚è∏':'‚ñ∂';}
tvAudio.addEventListener('ended',()=>{if(tvTracks.length)tvLoadTrack((tvCurTrack+1)%tvTracks.length,true);});

// ‚îÄ‚îÄ UNIFIED CONTROLS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function tvTogglePlay(){
    if(tvChannel==='video'){
        const vel=document.getElementById('tvVid'); if(!vel)return;
        if(tvPlaying){vel.pause();tvSetPlay(false);}else vel.play().then(()=>tvSetPlay(true)).catch(()=>{});
    } else {
        if(!tvTracks.length)return;
        if(tvPlaying){tvAudio.pause();tvSetPlay(false);}else tvAudio.play().then(()=>tvSetPlay(true)).catch(()=>{});
    }
}
function tvPrev(){
    if(tvChannel==='video')tvGoVid((tvCurVideo-1+Math.max(1,tvVideos.length))%Math.max(1,tvVideos.length));
    else if(tvChannel==='posts')tvGo((tvCur-1+Math.max(1,tvPosts.length))%Math.max(1,tvPosts.length));
    else if(tvTracks.length)tvLoadTrack((tvCurTrack-1+tvTracks.length)%tvTracks.length,tvPlaying);
}
function tvNext(){
    if(tvChannel==='video')tvGoVid((tvCurVideo+1)%Math.max(1,tvVideos.length));
    else if(tvChannel==='posts')tvGo((tvCur+1)%Math.max(1,tvPosts.length));
    else if(tvTracks.length)tvLoadTrack((tvCurTrack+1)%tvTracks.length,tvPlaying);
}

// ‚îÄ‚îÄ REMOTE CONTROLS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function rVol(delta){
    rVolVal=Math.max(0,Math.min(1,rVolVal+delta));
    tvAudio.volume=rVolVal; const vel=document.getElementById('tvVid'); if(vel)vel.volume=rVolVal;
    document.getElementById('rVolDisp').textContent=Math.round(rVolVal*100)+'%';
}
function rMute(){
    rMuted=!rMuted; tvAudio.muted=rMuted; const vel=document.getElementById('tvVid'); if(vel)vel.muted=rMuted;
    const btn=document.getElementById('rMuteBtn');
    btn.classList.toggle('on',rMuted);
    btn.innerHTML=rMuted?'<span>üîá</span>Muted':'<span>üîá</span>Mute';
    document.getElementById('rVolDisp').textContent=rMuted?'üîá':Math.round(rVolVal*100)+'%';
}
function rSpeed(dir){
    rSpdIdx=Math.max(0,Math.min(SPEEDS.length-1,rSpdIdx+dir));
    const s=SPEEDS[rSpdIdx]; tvAudio.playbackRate=s;
    const vel=document.getElementById('tvVid'); if(vel)vel.playbackRate=s;
    document.getElementById('rSpdDisp').textContent=s+'x';
}
function rQuality(){
    rHQ=!rHQ;
    document.getElementById('rQualBtn').innerHTML=rHQ?'<span>üì∫</span>HQ':'<span>üì∫</span>SD';
    document.getElementById('rQualBtn').classList.toggle('on',rHQ);
    tvScreen.style.filter=rHQ?'none':'blur(0.4px) contrast(0.85) saturate(0.7)';
}
function rBright(e){
    const tr=document.getElementById('rBrightTrack');
    const r=tr.getBoundingClientRect();
    rBrightVal=Math.max(20,Math.min(100,Math.round(((e.clientX-r.left)/r.width)*100)));
    document.getElementById('rBrightFill').style.width=rBrightVal+'%';
    tvScreen.style.filter=`brightness(${rBrightVal/100})`;
}

// ‚îÄ‚îÄ ADMIN PANEL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let tapOpen2=false;
function tvAdminPanel(e){
    if(e)e.stopPropagation();
    tapOpen2=!tapOpen2;
    const p=document.getElementById('tapWrap');
    p.classList.toggle('show',tapOpen2);
    const tr=ledTv.getBoundingClientRect();
    let l=tr.left-270; if(l<8)l=tr.right+8;
    p.style.left=l+'px'; p.style.top=Math.max(8,tr.top)+'px';
    p.style.right='auto'; p.style.bottom='auto';
    if(tapOpen2){tLoadPosts();tLoadSongs();tLoadVideos();}
}
document.addEventListener('click',e=>{if(tapOpen2&&!e.target.closest('#tapWrap')&&!e.target.closest('#tvEditBtn'))tvAdminPanel();});

function tSwitch(n){
    [1,2,3].forEach(i=>{
        document.getElementById('tPanel'+i).style.display=i===n?'block':'none';
        const b=document.getElementById('tTab'+i);
        b.style.background=i===n?'linear-gradient(135deg,#5b5ef4,#8b5cf6)':'white';
        b.style.color=i===n?'white':'#1a1a2e';
        b.style.borderColor=i===n?'#5b5ef4':'#e8eaf0';
    });
}
function tType(type){
    tPostType=type;
    ['Txt','Img'].forEach(t=>{
        const b=document.getElementById('tType'+t);
        const isOn=(t==='Txt'&&type==='text')||(t==='Img'&&type==='image');
        b.style.background=isOn?'linear-gradient(135deg,#5b5ef4,#8b5cf6)':'white';
        b.style.color=isOn?'white':'#1a1a2e'; b.style.borderColor=isOn?'#5b5ef4':'#e8eaf0';
    });
    document.getElementById('tImgField').style.display=type==='image'?'block':'none';
}
function tMsg(txt,ok){
    const e=document.getElementById('tapMsg');
    e.textContent=txt; e.style.cssText=`font-size:10px;font-weight:700;padding:5px 8px;border-radius:6px;margin-bottom:6px;display:block;background:${ok?'#d4edda':'#f8d7da'};color:${ok?'#155724':'#721c24'}`;
    setTimeout(()=>e.style.display='none',3000);
}

async function tLoadPosts(){
    try{const r=await fetch('/api/screen/posts');const posts=await r.json();
    document.getElementById('tPostList').innerHTML=posts.length?posts.map(p=>`
        <div class="tap-item"><span style="font-size:18px">${p.post_type==='image'?'üñºÔ∏è':'üìù'}</span>
        <div style="flex:1;min-width:0"><strong style="font-size:10px;display:block;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${p.title}</strong><small style="font-size:9px;color:#888">${p.post_type}</small></div>
        <button class="tap-del" onclick="tDelPost(${p.id})">‚úï</button></div>`).join(''):'<p style="font-size:10px;color:#aaa;text-align:center;padding:6px">Koi post nahi</p>';}catch(e){}
}
async function tAddPost(){
    const title=document.getElementById('tTitle').value.trim();
    if(!title){tMsg('‚ö†Ô∏è Title chahiye!',false);return;}
    const fd=new FormData();
    fd.append('title',title);fd.append('post_type',tPostType);
    fd.append('content',document.getElementById('tContent').value);
    fd.append('affiliate_url',document.getElementById('tAff').value);
    if(tPostType==='image'){const img=document.getElementById('tImage').files[0];if(!img){tMsg('‚ö†Ô∏è Image select karo!',false);return;}fd.append('image',img);}
    try{const r=await fetch('/api/screen/posts',{method:'POST',body:fd});const d=await r.json();
    if(d.message){tMsg(d.message,true);['tTitle','tContent','tAff'].forEach(id=>document.getElementById(id).value='');document.getElementById('tImage').value='';tLoadPosts();tvLoadPosts();}
    else tMsg(d.error||'Error!',false);}catch(e){tMsg('Failed!',false);}
}
async function tDelPost(id){if(!confirm('Remove?'))return;const r=await fetch('/api/screen/posts/'+id,{method:'DELETE'});const d=await r.json();tMsg(d.message||d.error,!!d.message);tLoadPosts();tvLoadPosts();}

async function tLoadSongs(){
    try{const r=await fetch('/api/music');const tracks=await r.json();
    document.getElementById('tSongList').innerHTML=tracks.length?tracks.map(t=>`
        <div class="tap-item"><span style="font-size:18px">üéµ</span>
        <div style="flex:1;min-width:0"><strong style="font-size:10px;display:block;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${t.title}</strong><small style="font-size:9px;color:#888">${t.artist||'Unknown'}</small></div>
        <button class="tap-del" onclick="tDelSong(${t.id})">‚úï</button></div>`).join(''):'<p style="font-size:10px;color:#aaa;text-align:center;padding:6px">Koi song nahi</p>';}catch(e){}
}
async function tUploadSong(){
    const file=document.getElementById('tSongFile').files[0];
    if(!file){tMsg('‚ö†Ô∏è File select karo!',false);return;}
    if(file.size>10*1024*1024){tMsg('‚ö†Ô∏è Max 10MB!',false);return;}
    const fd=new FormData();fd.append('audio',file);
    fd.append('title',document.getElementById('tSongTitle').value.trim()||file.name.replace(/\.[^/.]+$/,''));
    fd.append('artist',document.getElementById('tSongArtist').value.trim());
    tMsg('Uploading...',true);
    try{const r=await fetch('/api/music',{method:'POST',body:fd});const d=await r.json();
    if(d.message){tMsg(d.message,true);['tSongTitle','tSongArtist'].forEach(id=>document.getElementById(id).value='');document.getElementById('tSongFile').value='';tLoadSongs();tvLoadMusic();}
    else tMsg(d.error||'Error!',false);}catch(e){tMsg('Failed!',false);}
}
async function tDelSong(id){if(!confirm('Remove?'))return;const r=await fetch('/api/music/'+id,{method:'DELETE'});const d=await r.json();tMsg(d.message||d.error,!!d.message);tLoadSongs();tvLoadMusic();}

async function tLoadVideos(){
    try{const r=await fetch('/api/video');const vids=await r.json();
    document.getElementById('tVideoList').innerHTML=vids.length?vids.map(v=>`
        <div class="tap-item"><span style="font-size:18px">üé¨</span>
        <div style="flex:1;min-width:0"><strong style="font-size:10px;display:block;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${v.title}</strong><small style="font-size:9px;color:#888">${v.description||'Video'}</small></div>
        <button class="tap-del" onclick="tDelVideo(${v.id})">‚úï</button></div>`).join(''):'<p style="font-size:10px;color:#aaa;text-align:center;padding:6px">Koi video nahi</p>';}catch(e){}
}
async function tUploadVideo(){
    const file=document.getElementById('tVideoFile').files[0];
    if(!file){tMsg('‚ö†Ô∏è Video select karo!',false);return;}
    if(file.size>10*1024*1024){tMsg('‚ö†Ô∏è Max 10MB!',false);return;}
    const fd=new FormData();fd.append('video',file);
    fd.append('title',document.getElementById('tVideoTitle').value.trim()||file.name.replace(/\.[^/.]+$/,''));
    fd.append('description',document.getElementById('tVideoDesc').value.trim());
    tMsg('Uploading...',true);
    try{const r=await fetch('/api/video',{method:'POST',body:fd});const d=await r.json();
    if(d.message){tMsg(d.message,true);['tVideoTitle','tVideoDesc'].forEach(id=>document.getElementById(id).value='');document.getElementById('tVideoFile').value='';tLoadVideos();tvLoadVideos();}
    else tMsg(d.error||'Error!',false);}catch(e){tMsg('Failed!',false);}
}
async function tDelVideo(id){if(!confirm('Remove?'))return;const r=await fetch('/api/video/'+id,{method:'DELETE'});const d=await r.json();tMsg(d.message||d.error,!!d.message);tLoadVideos();tvLoadVideos();}

// ‚îÄ‚îÄ BUILT-IN CONTROL FUNCTIONS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function tvMuteToggle(){
    rMuted=!rMuted; tvAudio.muted=rMuted;
    const vel=document.getElementById('tvVid'); if(vel)vel.muted=rMuted;
    document.getElementById('tvMuteBtn').textContent=rMuted?'üîá':'üîä';
}
function tvVolChange(delta){
    rVolVal=Math.max(0,Math.min(1,rVolVal+delta));
    tvAudio.volume=rVolVal; const vel=document.getElementById('tvVid'); if(vel)vel.volume=rVolVal;
    document.getElementById('tvVolDisp').textContent=Math.round(rVolVal*100)+'%';
}
function tvSpeedChange(dir){
    rSpdIdx=Math.max(0,Math.min(SPEEDS.length-1,rSpdIdx+dir));
    const s=SPEEDS[rSpdIdx]; tvAudio.playbackRate=s;
    const vel=document.getElementById('tvVid'); if(vel)vel.playbackRate=s;
    document.getElementById('tvSpdDisp').textContent=s+'x';
}
function tvQualToggle(){
    rHQ=!rHQ;
    document.getElementById('tvQualBtn').textContent=rHQ?'üì∫HQ':'üì∫SD';
    tvScreen.style.filter=rHQ?'none':'blur(0.4px) contrast(0.85) saturate(0.7)';
}
function tvBrightSet(e){
    const tr=document.getElementById('tvBrightTrack');
    const r=tr.getBoundingClientRect();
    const pct=Math.max(20,Math.min(100,Math.round(((e.clientX-r.left)/r.width)*100)));
    document.getElementById('tvBrightFill').style.width=pct+'%';
    tvScreen.style.filter=`brightness(${pct/100})`;
}
// Aliases for old remote functions (backward compat)
function rVol(d){tvVolChange(d);}
function rMute(){tvMuteToggle();}
function rSpeed(d){tvSpeedChange(d);}
function rQuality(){tvQualToggle();}
function rBright(e){tvBrightSet(e);}

// ‚îÄ‚îÄ SWIPE GESTURE on TV Screen ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
(function(){
    let sx=0,moved=false;
    tvScreen.addEventListener('touchstart',e=>{sx=e.touches[0].clientX;moved=false;},{passive:true});
    tvScreen.addEventListener('touchmove',e=>{if(Math.abs(e.touches[0].clientX-sx)>10)moved=true;},{passive:true});
    tvScreen.addEventListener('touchend',e=>{
        if(!moved)return;
        const dx=e.changedTouches[0].clientX-sx;
        if(dx<-35)tvNext();       // ‚Üê swipe left = next
        else if(dx>35)tvPrev();   // ‚Üí swipe right = prev
    },{passive:true});
})();

// ‚îÄ‚îÄ INIT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function initTV(adminFlag){
    isAdmin=adminFlag;
    if(adminFlag)document.getElementById('tvEditBtn').style.display='block';
    tvLoadPosts(); tvLoadMusic(); tvLoadVideos();
    setTimeout(posRemote,400);
}
</script>
</body>
</html>

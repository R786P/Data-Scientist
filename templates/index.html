<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DS Agent</title>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;600;700&family=Sora:wght@600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lottie-web/5.12.2/lottie.min.js"></script>
    <style>
        :root {
            --p: #5b5ef4;
            --p2: #8b5cf6;
            --acc: #06d6a0;
            --bg: #f6f7fb;
            --surface: #ffffff;
            --text: #1a1a2e;
            --muted: #8890a4;
            --border: #e8eaf0;
            --radius: 18px;
        }
        * { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
        body { font-family:'DM Sans',sans-serif; background:var(--bg); min-height:100vh; overflow-x:hidden; }

        /* ‚ïê‚ïê OVERLAY (drawer backdrop) ‚ïê‚ïê */
        .overlay { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.4); z-index:400; backdrop-filter:blur(2px); }
        .overlay.show { display:block; }

        /* ‚ïê‚ïê SIDE DRAWER ‚ïê‚ïê */
        .drawer {
            position:fixed; top:0; left:0; bottom:0; width:280px;
            background:var(--surface); z-index:500;
            transform:translateX(-100%); transition:transform 0.3s cubic-bezier(0.4,0,0.2,1);
            display:flex; flex-direction:column; box-shadow:4px 0 30px rgba(0,0,0,0.12);
        }
        .drawer.open { transform:translateX(0); }
        .drawer-header {
            padding:20px 20px 16px;
            border-bottom:1px solid var(--border);
            display:flex; align-items:center; gap:12px;
        }
        .drawer-avatar {
            width:42px; height:42px; border-radius:50%;
            background:linear-gradient(135deg,var(--p),var(--p2));
            display:flex; align-items:center; justify-content:center;
            color:white; font-weight:700; font-size:16px; flex-shrink:0;
        }
        .drawer-user h4 { font-size:15px; font-weight:700; color:var(--text); }
        .drawer-user span { font-size:11px; color:var(--muted); font-weight:500; }
        .plan-pill {
            display:inline-block; padding:2px 8px; border-radius:20px;
            font-size:10px; font-weight:700; margin-left:4px;
        }
        .plan-pill.free { background:#f0f0f0; color:#888; }
        .plan-pill.pro { background:linear-gradient(135deg,var(--p),var(--p2)); color:white; }

        .drawer-section { padding:12px 12px 4px; }
        .drawer-section-label {
            font-size:10px; font-weight:700; color:var(--muted);
            text-transform:uppercase; letter-spacing:1.2px;
            padding:0 8px; margin-bottom:6px;
        }
        .drawer-item {
            display:flex; align-items:center; gap:12px;
            padding:11px 12px; border-radius:12px; cursor:pointer;
            text-decoration:none; color:var(--text);
            font-size:14px; font-weight:500; transition:0.15s;
        }
        .drawer-item:hover { background:#f4f4f8; }
        .drawer-item.active { background:linear-gradient(135deg,#eef0ff,#f0e8ff); color:var(--p); font-weight:700; }
        .drawer-item .di-icon { font-size:18px; width:28px; text-align:center; }
        .drawer-item .di-badge { margin-left:auto; font-size:9px; font-weight:800; background:linear-gradient(135deg,var(--p),var(--p2)); color:white; padding:2px 7px; border-radius:8px; }
        .drawer-footer { margin-top:auto; padding:16px 12px; border-top:1px solid var(--border); }
        .drawer-footer a { display:flex; align-items:center; gap:10px; padding:10px 12px; border-radius:12px; color:var(--muted); font-size:13px; font-weight:600; text-decoration:none; transition:0.15s; }
        .drawer-footer a:hover { background:#fef0f0; color:#e74c3c; }

        /* ‚ïê‚ïê TOP BAR ‚ïê‚ïê */
        .topbar {
            position:sticky; top:0; z-index:200;
            display:flex; align-items:center; justify-content:space-between;
            padding:14px 18px; background:rgba(246,247,251,0.9);
            backdrop-filter:blur(12px); border-bottom:1px solid transparent;
        }
        .menu-btn {
            width:38px; height:38px; border:none; background:var(--surface);
            border-radius:12px; display:flex; align-items:center; justify-content:center;
            cursor:pointer; box-shadow:0 2px 8px rgba(0,0,0,0.08); font-size:18px;
            transition:0.15s;
        }
        .menu-btn:hover { background:#eef0ff; }
        .topbar-title { font-family:'Sora',sans-serif; font-size:16px; font-weight:700; color:var(--text); }
        .topbar-right { display:flex; align-items:center; gap:8px; }
        .top-avatar {
            width:34px; height:34px; border-radius:50%;
            background:linear-gradient(135deg,var(--p),var(--p2));
            display:flex; align-items:center; justify-content:center;
            color:white; font-weight:700; font-size:13px; cursor:pointer;
        }

        /* ‚ïê‚ïê MAIN CONTENT ‚ïê‚ïê */
        .main {
            display:flex; flex-direction:column; align-items:center;
            min-height:calc(100vh - 66px);
            padding:0 0 140px;
        }

        /* ‚ïê‚ïê CENTER SECTION ‚ïê‚ïê */
        .center-section {
            display:flex; flex-direction:column; align-items:center;
            padding:30px 20px 0; width:100%; max-width:600px;
            text-align:center;
        }

        /* ‚ïê‚ïê MASCOT ‚ïê‚ïê */
        .mascot-wrap { position:relative; margin-bottom:10px; cursor:pointer; }
        #lottie-bot { width:120px; height:120px; }
        .speech-bubble {
            position:absolute; bottom:100%; left:50%; transform:translateX(-50%);
            background:var(--surface); border-radius:14px; padding:8px 14px;
            font-size:12px; font-weight:600; color:var(--text); white-space:nowrap;
            box-shadow:0 4px 20px rgba(0,0,0,0.1); border:1px solid var(--border);
            opacity:0; pointer-events:none; margin-bottom:8px;
            transition:all 0.3s cubic-bezier(0.34,1.56,0.64,1);
            transform:translateX(-50%) scale(0.85);
        }
        .speech-bubble::after { content:''; position:absolute; top:100%; left:50%; transform:translateX(-50%); border:7px solid transparent; border-top-color:var(--surface); }
        .speech-bubble.show { opacity:1; transform:translateX(-50%) scale(1); }

        /* ‚ïê‚ïê WELCOME TEXT ‚ïê‚ïê */
        .welcome-small { font-size:14px; color:var(--muted); font-weight:500; margin-bottom:4px; }
        .welcome-name {
            font-family:'Sora',sans-serif; font-size:28px; font-weight:800;
            background:linear-gradient(135deg,var(--p),var(--p2));
            -webkit-background-clip:text; -webkit-text-fill-color:transparent;
            margin-bottom:6px;
        }
        .welcome-sub { font-size:14px; color:var(--muted); font-weight:500; margin-bottom:24px; }

        /* ‚ïê‚ïê UPLOAD ZONE ‚ïê‚ïê */
        .upload-zone {
            width:100%; border:2px dashed #d0d4e8; border-radius:16px;
            padding:18px; text-align:center; cursor:pointer;
            background:var(--surface); transition:0.2s; margin-bottom:16px;
        }
        .upload-zone:hover { border-color:var(--p); background:#f8f8ff; }
        .upload-zone p { color:var(--p); font-size:14px; font-weight:600; margin-bottom:2px; }
        .upload-zone small { color:var(--muted); font-size:12px; }
        .upload-zone.synced { border-color:var(--acc); border-style:solid; background:#f0fdf8; }
        .upload-zone.synced p { color:#059669; }

        /* ‚ïê‚ïê REACTION MESSAGE ‚ïê‚ïê */
        .reaction-row {
            display:flex; align-items:flex-end; gap:8px;
            width:100%; max-width:600px; padding:0 16px;
            margin-bottom:12px;
        }
        .r-char { font-size:30px; flex-shrink:0; line-height:1; }
        .r-bubble {
            background:var(--surface); border-radius:16px 16px 16px 4px;
            padding:10px 14px; font-size:13px; font-weight:500; color:var(--text);
            box-shadow:0 2px 12px rgba(0,0,0,0.06); border:1px solid var(--border);
            max-width:85%; position:relative; line-height:1.5; white-space:pre-wrap;
            word-wrap:break-word;
        }
        .r-bubble.user { background:linear-gradient(135deg,var(--p),var(--p2)); color:white; border-radius:16px 16px 4px 16px; border:none; margin-left:auto; }
        .r-bubble.ai-mode { background:linear-gradient(135deg,#f0f0ff,#f5f0ff); }
        .reaction-row.user-row { flex-direction:row-reverse; }
        .r-actions { position:absolute; top:4px; right:6px; display:flex; gap:2px; opacity:0; transition:0.2s; }
        .r-bubble:hover .r-actions { opacity:1; }
        .r-action-btn { background:rgba(0,0,0,0.08); border:none; border-radius:4px; padding:2px 5px; cursor:pointer; font-size:10px; }

        /* Typing */
        .typing-dots span { height:6px; width:6px; background:var(--p); border-radius:50%; display:inline-block; margin:0 2px; animation:tdot 1.4s infinite; }
        .typing-dots span:nth-child(2){animation-delay:0.2s}
        .typing-dots span:nth-child(3){animation-delay:0.4s}
        @keyframes tdot{0%,60%,100%{transform:translateY(0)}30%{transform:translateY(-5px)}}

        /* ‚ïê‚ïê CHAT BOX (hidden scroll area) ‚ïê‚ïê */
        .chat-area {
            width:100%; max-width:600px;
            display:flex; flex-direction:column;
            gap:0; padding-bottom:4px;
            overflow-y:auto; max-height:340px;
        }

        /* ‚ïê‚ïê AI TOGGLE inside input area ‚ïê‚ïê */
        .ai-toggle-row {
            display:flex; align-items:center; justify-content:center; gap:8px;
            padding:6px 0; margin-bottom:4px;
        }
        .ai-toggle-row span { font-size:11px; color:var(--muted); font-weight:600; }
        .toggle-sw { position:relative; width:42px; height:22px; }
        .toggle-sw input { opacity:0; width:0; height:0; }
        .toggle-sl { position:absolute; cursor:pointer; inset:0; background:#d0d4e8; border-radius:22px; transition:0.3s; }
        .toggle-sl:before { position:absolute; content:""; height:16px; width:16px; left:3px; bottom:3px; background:white; border-radius:50%; transition:0.3s; }
        input:checked+.toggle-sl { background:linear-gradient(135deg,var(--p),var(--p2)); }
        input:checked+.toggle-sl:before { transform:translateX(20px); }
        .ai-on-badge { background:linear-gradient(135deg,var(--p),var(--p2)); color:white; padding:2px 8px; border-radius:8px; font-size:10px; font-weight:800; display:none; }
        .ai-on-badge.on { display:inline-block; }

        /* ‚ïê‚ïê BOTTOM INPUT BAR (fixed) ‚ïê‚ïê */
        .input-bar {
            position:fixed; bottom:0; left:0; right:0;
            background:var(--bg); padding:10px 16px 16px;
            border-top:1px solid var(--border);
            z-index:300;
        }
        .input-wrap {
            display:flex; align-items:center; gap:8px;
            background:var(--surface); border-radius:16px;
            padding:8px 10px 8px 14px;
            box-shadow:0 2px 16px rgba(0,0,0,0.1);
            border:1px solid var(--border);
        }
        .input-wrap input {
            flex:1; border:none; outline:none; font-size:15px;
            font-family:'DM Sans',sans-serif; background:transparent;
            color:var(--text); font-weight:500;
        }
        .input-wrap input::placeholder { color:#b0b8cc; }
        .input-wrap input:disabled { cursor:not-allowed; opacity:0.5; }
        .input-btn {
            width:38px; height:38px; border:none; border-radius:12px;
            cursor:pointer; display:flex; align-items:center; justify-content:center;
            font-size:16px; transition:0.15s; flex-shrink:0; background:transparent;
        }
        .input-btn:hover { background:#f0f0f8; }
        .plus-btn { background:#f0f0f8; color:var(--p); font-size:20px; font-weight:300; }
        .plus-btn:hover { background:#e8e8ff; }
        .voice-btn.listening { background:linear-gradient(135deg,#ef4444,#f97316); color:white; animation:pulse-v 1s infinite; }
        @keyframes pulse-v { 0%,100%{box-shadow:0 0 0 0 rgba(239,68,68,0.4)}50%{box-shadow:0 0 0 8px rgba(239,68,68,0)}}
        .send-btn { background:linear-gradient(135deg,var(--p),var(--p2)); color:white; }
        .send-btn:hover { opacity:0.9; transform:scale(1.05); }
        .send-btn:disabled { background:#d0d4e8; cursor:not-allowed; transform:none; }
        .voice-status { font-size:11px; color:var(--p); font-weight:600; text-align:center; margin-top:4px; height:14px; }

        /* ‚ïê‚ïê PLUS MENU (popup above input) ‚ïê‚ïê */
        .plus-menu {
            position:fixed; bottom:80px; left:16px; right:16px;
            background:var(--surface); border-radius:20px;
            box-shadow:0 -4px 30px rgba(0,0,0,0.12);
            border:1px solid var(--border);
            padding:16px; z-index:400;
            transform:translateY(20px) scale(0.95); opacity:0;
            pointer-events:none; transition:all 0.25s cubic-bezier(0.34,1.56,0.64,1);
        }
        .plus-menu.show { transform:translateY(0) scale(1); opacity:1; pointer-events:all; }
        .plus-menu-title { font-size:11px; font-weight:700; color:var(--muted); text-transform:uppercase; letter-spacing:1px; margin-bottom:12px; }
        .pm-grid { display:grid; grid-template-columns:repeat(4,1fr); gap:8px; }
        .pm-item {
            display:flex; flex-direction:column; align-items:center; gap:5px;
            padding:12px 6px; border-radius:14px; cursor:pointer;
            background:#f8f9fc; border:1px solid var(--border); transition:0.15s;
        }
        .pm-item:hover { background:#eef0ff; border-color:var(--p); }
        .pm-item .pm-icon { font-size:22px; }
        .pm-item .pm-label { font-size:10px; font-weight:700; color:var(--text); text-align:center; line-height:1.2; }
        .pm-item .pm-pro { font-size:8px; color:var(--p); font-weight:800; }
        .pm-voice-row { display:flex; gap:8px; margin-top:10px; padding-top:10px; border-top:1px solid var(--border); align-items:center; }
        .pm-voice-row label { font-size:12px; font-weight:700; color:var(--text); flex-shrink:0; }
        .gender-btn { padding:5px 14px; border-radius:20px; border:2px solid var(--border); cursor:pointer; font-size:12px; font-weight:700; background:white; transition:0.15s; font-family:'DM Sans',sans-serif; }
        .gender-btn.active { border-color:var(--p); background:linear-gradient(135deg,var(--p),var(--p2)); color:white; }
        .speed-wrap { display:flex; align-items:center; gap:6px; margin-left:auto; }
        .speed-wrap label { font-size:10px; color:var(--muted); font-weight:600; }
        .speed-wrap input { width:70px; accent-color:var(--p); }

        /* ‚ïê‚ïê SPEAKING INDICATOR ‚ïê‚ïê */
        .speaking-row { display:none; justify-content:center; gap:3px; align-items:center; padding:4px 0; }
        .speaking-row.on { display:flex; }
        .sp-bar { width:3px; height:14px; background:var(--p); border-radius:2px; }
        .sp-bar:nth-child(1){animation:sw .6s ease infinite 0s}
        .sp-bar:nth-child(2){animation:sw .6s ease infinite .1s}
        .sp-bar:nth-child(3){animation:sw .6s ease infinite .2s}
        .sp-bar:nth-child(4){animation:sw .6s ease infinite .3s}
        .sp-bar:nth-child(5){animation:sw .6s ease infinite .4s}
        @keyframes sw{0%,100%{transform:scaleY(1)}50%{transform:scaleY(1.8)}}

        /* ‚ïê‚ïê SESSION EXPIRED ‚ïê‚ïê */
        .sess-overlay { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.7); justify-content:center; align-items:center; z-index:9000; }
        .sess-overlay.show { display:flex; }
        .sess-card { background:white; border-radius:20px; padding:28px; text-align:center; max-width:300px; width:90%; }
        .sess-card h3 { color:#ef4444; font-size:18px; font-weight:800; margin-bottom:8px; }
        .sess-card p { color:var(--muted); font-size:13px; margin-bottom:18px; }
        .sess-card a { display:block; padding:12px; background:linear-gradient(135deg,var(--p),var(--p2)); color:white; border-radius:12px; text-decoration:none; font-weight:700; }

        /* ‚ïê‚ïê AFFILIATE POPUP ‚ïê‚ïê */
        .aff-overlay { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.55); justify-content:center; align-items:center; z-index:8000; backdrop-filter:blur(3px); }
        .aff-overlay.show { display:flex; }
        .aff-card { background:white; border-radius:22px; padding:26px 22px; width:90%; max-width:360px; text-align:center; animation:pop .4s cubic-bezier(0.34,1.56,0.64,1); }
        @keyframes pop { 0%{transform:scale(0.7);opacity:0}100%{transform:scale(1);opacity:1} }
        .aff-sponsor { font-size:10px; color:#aaa; font-weight:700; text-transform:uppercase; letter-spacing:1px; margin-bottom:8px; }
        .aff-card h3 { font-family:'Sora',sans-serif; font-size:18px; font-weight:700; color:var(--text); margin-bottom:6px; }
        .aff-card p { font-size:13px; color:var(--muted); margin-bottom:16px; }
        .aff-visit { display:block; padding:12px; background:linear-gradient(135deg,var(--p),var(--p2)); color:white; border-radius:12px; text-decoration:none; font-weight:700; font-size:14px; margin-bottom:8px; }
        .aff-skip { background:none; border:none; cursor:pointer; color:var(--muted); font-size:12px; font-weight:600; font-family:'DM Sans',sans-serif; padding:4px; }

        /* ‚ïê‚ïê DOWNLOAD PANEL (shown inside plus menu when available) ‚ïê‚ïê */
        .dl-section { margin-top:10px; padding-top:10px; border-top:1px solid var(--border); display:none; }
        .dl-section.show { display:block; }
        .dl-title { font-size:11px; font-weight:700; color:var(--muted); text-transform:uppercase; letter-spacing:1px; margin-bottom:8px; }
        .dl-btns { display:flex; flex-wrap:wrap; gap:6px; }
        .dl-btn { padding:6px 12px; border-radius:10px; border:1px solid var(--border); background:white; font-size:11px; font-weight:700; cursor:pointer; font-family:'DM Sans',sans-serif; color:var(--text); transition:0.15s; display:flex; align-items:center; gap:4px; }
        .dl-btn:hover { background:#eef0ff; border-color:var(--p); color:var(--p); }
        .dl-btn:disabled { opacity:0.4; cursor:not-allowed; }
        .email-dl-btn { width:100%; padding:10px; background:linear-gradient(135deg,#059669,#34d399); color:white; border:none; border-radius:10px; font-size:13px; font-weight:700; cursor:pointer; font-family:'DM Sans',sans-serif; margin-top:8px; }

        /* ‚ïê‚ïê EMAIL MODAL ‚ïê‚ïê */
        .modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5); justify-content:center; align-items:center; z-index:7000; }
        .modal.show { display:flex; }
        .modal-card { background:white; border-radius:20px; padding:24px; width:90%; max-width:360px; }
        .modal-card h3 { font-size:17px; font-weight:800; color:var(--text); margin-bottom:14px; }
        .modal-card input { width:100%; padding:11px 14px; border:2px solid var(--border); border-radius:12px; font-size:14px; font-family:'DM Sans',sans-serif; outline:none; margin-bottom:12px; }
        .modal-card input:focus { border-color:var(--p); }
        .modal-btns { display:flex; gap:8px; }
        .modal-btns button { flex:1; padding:10px; border:none; border-radius:10px; cursor:pointer; font-weight:700; font-family:'DM Sans',sans-serif; }
        .m-send { background:linear-gradient(135deg,var(--p),var(--p2)); color:white; }
        .m-cancel { background:#f0f0f0; color:var(--text); }

        /* ‚ïê‚ïê VIEWER ‚ïê‚ïê */
        .viewer-modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.88); justify-content:center; align-items:center; z-index:9000; }
        .viewer-modal.show { display:flex; }
        .viewer-content { background:white; border-radius:20px; padding:18px; width:96%; max-width:740px; max-height:88vh; overflow:auto; position:relative; }
        .viewer-content img { max-width:100%; border-radius:10px; }
        .viewer-content iframe { width:100%; height:460px; border:none; }
        .v-close { position:absolute; top:10px; right:14px; font-size:26px; cursor:pointer; color:var(--p); font-weight:900; line-height:1; }

        /* ‚ïê‚ïê QUERY BAR ‚ïê‚ïê */
        .query-bar { display:none; align-items:center; gap:8px; background:var(--surface); border-radius:12px; padding:8px 14px; margin:8px 16px 0; box-shadow:0 1px 6px rgba(0,0,0,0.06); }
        .query-bar.show { display:flex; }
        .qb-text { font-size:11px; font-weight:700; color:var(--muted); white-space:nowrap; }
        .qb-prog { flex:1; height:5px; background:#eee; border-radius:4px; overflow:hidden; }
        .qb-fill { height:100%; background:linear-gradient(90deg,var(--p),var(--p2)); border-radius:4px; transition:0.5s; }
        .qb-link { font-size:11px; color:var(--p); font-weight:800; text-decoration:none; white-space:nowrap; }

        .loader { border:3px solid #eee; border-top:3px solid var(--p); border-radius:50%; width:16px; height:16px; animation:spin .8s linear infinite; display:inline-block; vertical-align:middle; }
        @keyframes spin{to{transform:rotate(360deg)}}
    </style>
</head>
<body>

<!-- SESSION EXPIRED -->
<div class="sess-overlay" id="sessOverlay">
    <div class="sess-card">
        <h3>üîí Session Expire!</h3>
        <p>Aapka account kisi aur device pe login hua. Please dobara login karo.</p>
        <a href="/login">üîë Login Again</a>
    </div>
</div>

<!-- AFFILIATE POPUP -->
<div class="aff-overlay" id="affOverlay">
    <div class="aff-card">
        <div class="aff-sponsor">üì¢ Sponsored</div>
        <h3 id="affTitle">Partner Offer</h3>
        <p id="affDesc">Check out this amazing tool!</p>
        <a href="#" id="affLink" class="aff-visit" target="_blank" rel="noopener" onclick="proceedDl()">Visit Partner ‚Üí</a>
        <button class="aff-skip" onclick="proceedDl()">Skip & Download</button>
    </div>
</div>

<!-- OVERLAY (drawer) -->
<div class="overlay" id="overlay" onclick="closeDrawer()"></div>

<!-- SIDE DRAWER -->
<div class="drawer" id="drawer">
    <div class="drawer-header">
        <div class="drawer-avatar" id="drawerAvatar">?</div>
        <div class="drawer-user">
            <h4 id="drawerName">Loading...</h4>
            <span id="drawerSub">Free plan <span class="plan-pill free" id="drawerPill">Free</span></span>
        </div>
    </div>

    <div class="drawer-section">
        <div class="drawer-section-label">Main</div>
        <a class="drawer-item active" href="/">
            <span class="di-icon">üè†</span> Home
        </a>
        <a class="drawer-item" href="/dashboard">
            <span class="di-icon">üìä</span> Dashboard
            <span class="di-badge">Pro</span>
        </a>
        <a class="drawer-item" href="/pricing">
            <span class="di-icon">‚≠ê</span> Upgrade to Pro
        </a>
    </div>

    <div class="drawer-section" id="adminSection" style="display:none">
        <div class="drawer-section-label">Admin</div>
        <a class="drawer-item" href="/admin">
            <span class="di-icon">üõ°Ô∏è</span> Admin Panel
        </a>
        <a class="drawer-item" onclick="openDrawerAffiliate()">
            <span class="di-icon">üîó</span> Affiliate Links
        </a>
        <a class="drawer-item" onclick="openDrawerUsers()">
            <span class="di-icon">üë•</span> Manage Users
        </a>
    </div>

    <div class="drawer-section">
        <div class="drawer-section-label">Quick Commands</div>
        <div class="drawer-item" onclick="quickCmd('dashboard')"><span class="di-icon">üìà</span> Show Dashboard</div>
        <div class="drawer-item" onclick="quickCmd('kpi')"><span class="di-icon">üéØ</span> KPI Cards</div>
        <div class="drawer-item" onclick="quickCmd('top 5')"><span class="di-icon">üèÜ</span> Top 5</div>
        <div class="drawer-item" onclick="quickCmd('average')"><span class="di-icon">üî¢</span> Average</div>
        <div class="drawer-item" onclick="quickCmd('bar chart')"><span class="di-icon">üìâ</span> Bar Chart</div>
    </div>

    <div class="drawer-footer">
        <a href="/logout">üö™ Logout</a>
    </div>
</div>

<!-- TOP BAR -->
<div class="topbar">
    <button class="menu-btn" onclick="openDrawer()">‚ò∞</button>
    <span class="topbar-title">ü§ñ DS Agent</span>
    <div class="topbar-right">
        <div class="top-avatar" id="topAvatar" onclick="openDrawer()">?</div>
    </div>
</div>

<!-- QUERY PROGRESS BAR -->
<div class="query-bar" id="queryBar">
    <span class="qb-text" id="qbText">0/10</span>
    <div class="qb-prog"><div class="qb-fill" id="qbFill" style="width:0%"></div></div>
    <a href="/pricing" class="qb-link">‚≠ê Upgrade</a>
</div>

<!-- MAIN -->
<div class="main">
    <div class="center-section">

        <!-- MASCOT -->
        <div class="mascot-wrap" onclick="mascotTap()">
            <div class="speech-bubble" id="bubble">Namaste! üëã</div>
            <div id="lottie-bot"></div>
        </div>

        <!-- SPEAKING -->
        <div class="speaking-row" id="speakRow">
            <div class="sp-bar"></div><div class="sp-bar"></div>
            <div class="sp-bar"></div><div class="sp-bar"></div><div class="sp-bar"></div>
        </div>

        <!-- WELCOME -->
        <div class="welcome-small">‡§®‡§Æ‡§∏‡•ç‡§§‡•á,</div>
        <div class="welcome-name" id="wName">...</div>
        <div class="welcome-sub" id="wSub">‡§ï‡§π‡§æ‡§Å ‡§∏‡•á ‡§∂‡•Å‡§∞‡•Å‡§Ü‡§§ ‡§ï‡§∞‡•á‡§Ç?</div>

        <!-- UPLOAD -->
        <div class="upload-zone" id="uploadZone" onclick="document.getElementById('fileIn').click()">
            <p id="uploadTxt">üìÅ CSV / Excel Upload ‡§ï‡§∞‡•á‡§Ç</p>
            <small>Click to select file</small>
            <input type="file" id="fileIn" accept=".csv,.xlsx" style="display:none" onchange="uploadFile(this)">
        </div>

        <!-- AI TOGGLE -->
        <div class="ai-toggle-row">
            <span>‚ö° Command</span>
            <label class="toggle-sw">
                <input type="checkbox" id="aiToggle" onchange="toggleAI(this)">
                <span class="toggle-sl"></span>
            </label>
            <span>ü§ñ AI Chat</span>
            <span class="ai-on-badge" id="aiBadge">ON</span>
        </div>

    </div>

    <!-- CHAT AREA -->
    <div class="chat-area" id="chatArea"></div>

</div>

<!-- PLUS MENU -->
<div class="plus-menu" id="plusMenu">
    <div class="plus-menu-title">üõ† Tools & Downloads</div>
    <div class="pm-grid">
        <div class="pm-item" onclick="quickCmd('dashboard');closePlus()">
            <span class="pm-icon">üìä</span>
            <span class="pm-label">Dashboard</span>
            <span class="pm-pro">Pro</span>
        </div>
        <div class="pm-item" onclick="quickCmd('kpi');closePlus()">
            <span class="pm-icon">üìà</span>
            <span class="pm-label">KPI Cards</span>
        </div>
        <div class="pm-item" onclick="quickCmd('top 5');closePlus()">
            <span class="pm-icon">üèÜ</span>
            <span class="pm-label">Top 5</span>
        </div>
        <div class="pm-item" onclick="quickCmd('bar chart');closePlus()">
            <span class="pm-icon">üìâ</span>
            <span class="pm-label">Bar Chart</span>
        </div>
        <div class="pm-item" onclick="quickCmd('export excel');closePlus()">
            <span class="pm-icon">üìÑ</span>
            <span class="pm-label">Excel</span>
            <span class="pm-pro">Pro</span>
        </div>
        <div class="pm-item" onclick="quickCmd('export csv');closePlus()">
            <span class="pm-icon">üìã</span>
            <span class="pm-label">CSV</span>
        </div>
        <div class="pm-item" onclick="quickCmd('export html');closePlus()">
            <span class="pm-icon">üåê</span>
            <span class="pm-label">HTML</span>
        </div>
        <div class="pm-item" onclick="quickCmd('average');closePlus()">
            <span class="pm-icon">üî¢</span>
            <span class="pm-label">Average</span>
        </div>
    </div>

    <!-- Voice settings inside plus -->
    <div class="pm-voice-row">
        <label>üîä</label>
        <button class="gender-btn active" id="btnF" onclick="setGender('female')">üë© Female</button>
        <button class="gender-btn" id="btnM" onclick="setGender('male')">üë® Male</button>
        <div class="speed-wrap">
            <label>Speed</label>
            <input type="range" id="spd" min="0.5" max="1.8" step="0.1" value="0.95" oninput="document.getElementById('spdVal').textContent=this.value+'x'">
            <span id="spdVal" style="font-size:10px;font-weight:700;color:var(--p)">0.95x</span>
        </div>
    </div>

    <!-- Downloads (appear when ready) -->
    <div class="dl-section" id="dlSection">
        <div class="dl-title">üì• Downloads</div>
        <div class="dl-btns">
            <button class="dl-btn" id="dlPlot" onclick="triggerDl('plot')" disabled>üìä Plot</button>
            <button class="dl-btn" id="dlDash" onclick="triggerDl('dashboard')" disabled>üìà Dashboard</button>
            <button class="dl-btn" id="dlExcel" onclick="triggerDl('excel')" disabled>üìÑ Excel</button>
            <button class="dl-btn" id="dlCSV" onclick="triggerDl('csv')" disabled>üìã CSV</button>
            <button class="dl-btn" id="dlHTML" onclick="triggerDl('html')" disabled>üåê HTML</button>
            <button class="dl-btn" onclick="dlAllReports()">üìù All Reports</button>
        </div>
        <button class="email-dl-btn" onclick="document.getElementById('emailModal').classList.add('show');closePlus()">üìß Email Reports</button>
    </div>
</div>

<!-- INPUT BAR -->
<div class="input-bar">
    <div class="input-wrap">
        <button class="input-btn plus-btn" onclick="togglePlus()">+</button>
        <input type="text" id="msgInput" placeholder="Pehle file upload karo..." disabled>
        <button class="input-btn voice-btn" id="voiceBtn" onclick="toggleVoice()">üé§</button>
        <button class="input-btn send-btn" id="sendBtn" onclick="sendMsg()" disabled>‚û§</button>
    </div>
    <div class="voice-status" id="vStatus"></div>
</div>

<!-- EMAIL MODAL -->
<div class="modal" id="emailModal">
    <div class="modal-card">
        <h3>üìß Send Report</h3>
        <input type="email" id="emailInput" placeholder="Client ka email">
        <div class="modal-btns">
            <button class="m-send" onclick="sendReport()">Send</button>
            <button class="m-cancel" onclick="document.getElementById('emailModal').classList.remove('show')">Cancel</button>
        </div>
    </div>
</div>

<!-- VIEWER -->
<div class="viewer-modal" id="viewerModal">
    <div class="viewer-content">
        <span class="v-close" onclick="closeViewer()">&times;</span>
        <div id="viewerBox"></div>
    </div>
</div>

<script>
// ‚ïê‚ïê STATE ‚ïê‚ïê
let fileReady=false, processing=false, aiMode=false;
let history=[], plotR=false, dashR=false, excelR=false, csvR=false, htmlR=false;
let recog=null, listening=false, voiceGender='female';
let affiliates=[], pendingDl=null, bubbleTimer=null;
let plan='free';

// ‚ïê‚ïê REACTIONS ‚ïê‚ïê
const RX={
    success:{e:'üéâ',l:'Woohoo!',a:'celebrate'},happy:{e:'üòä',l:'Nice!',a:''},
    excited:{e:'ü§©',l:'Amazing!',a:'celebrate'},thinking:{e:'ü§î',l:'Hmm...',a:'think'},
    data:{e:'üìä',l:'Data!',a:''},error:{e:'üòÖ',l:'Oops!',a:'shake'},
    chart:{e:'üìà',l:'Chart!',a:'celebrate'},save:{e:'üíæ',l:'Saved!',a:''},
    hi:{e:'üëã',l:'Hello!',a:''},tip:{e:'üí°',l:'Tip!',a:''},
    pro:{e:'‚≠ê',l:'Pro!',a:''}
};
function getRx(t){
    const s=t.toLowerCase();
    if(s.includes('‚úÖ')||s.includes('success')||s.includes('saved'))return RX.success;
    if(s.includes('‚≠ê')||s.includes('pro plan')||s.includes('upgrade'))return RX.pro;
    if(s.includes('dashboard'))return RX.chart;
    if(s.includes('‚ùå')||s.includes('error')||s.includes('‚ö†Ô∏è'))return RX.error;
    if(s.includes('chart')||s.includes('plot')||s.includes('graph'))return RX.chart;
    if(s.includes('excel')||s.includes('csv')||s.includes('export'))return RX.save;
    if(s.includes('total')||s.includes('average')||s.includes('üìä'))return RX.data;
    if(s.includes('üí°'))return RX.tip;
    if(s.includes('hello')||s.includes('namaste')||s.includes('hi'))return RX.hi;
    return RX.happy;
}

// ‚ïê‚ïê MASCOT ‚ïê‚ïê
function initMascot(){
    lottie.loadAnimation({container:document.getElementById('lottie-bot'),renderer:'svg',loop:true,autoplay:true,
        path:'https://assets9.lottiefiles.com/packages/lf20_qp1q7mct.json'
    }).addEventListener('data_failed',()=>{
        document.getElementById('lottie-bot').innerHTML='<div style="font-size:80px;text-align:center;line-height:120px;animation:bob 2s ease-in-out infinite">ü§ñ</div>';
        const s=document.createElement('style');s.textContent='@keyframes bob{0%,100%{transform:translateY(0)}50%{transform:translateY(-12px)}}';document.head.appendChild(s);
    });
    setTimeout(()=>bubble('Data upload karo! üöÄ'),1500);
}
function bubble(text){
    const b=document.getElementById('bubble');
    b.textContent=text; b.classList.add('show');
    clearTimeout(bubbleTimer);
    bubbleTimer=setTimeout(()=>b.classList.remove('show'),3000);
}
function mascotTap(){
    const msgs=['Kya analysis karni hai? ü§î','Mera naam DS Agent hai! üòÑ','Dashboard try karo! üìä','AI Mode try karo üß†','Main ready hoon! üí™'];
    bubble(msgs[Math.floor(Math.random()*msgs.length)]);
}

// ‚ïê‚ïê DRAWER ‚ïê‚ïê
function openDrawer(){document.getElementById('drawer').classList.add('open');document.getElementById('overlay').classList.add('show');}
function closeDrawer(){document.getElementById('drawer').classList.remove('open');document.getElementById('overlay').classList.remove('show');}
function openDrawerAffiliate(){closeDrawer();window.location.href='/admin';}
function openDrawerUsers(){closeDrawer();window.location.href='/admin';}

// ‚ïê‚ïê PLUS MENU ‚ïê‚ïê
let plusOpen=false;
function togglePlus(){plusOpen=!plusOpen;document.getElementById('plusMenu').classList.toggle('show',plusOpen);}
function closePlus(){plusOpen=false;document.getElementById('plusMenu').classList.remove('show');}
document.addEventListener('click',e=>{if(plusOpen&&!e.target.closest('#plusMenu')&&!e.target.closest('.plus-btn'))closePlus();});

// ‚ïê‚ïê VOICE GENDER ‚ïê‚ïê
function setGender(g){
    voiceGender=g;
    document.getElementById('btnF').className='gender-btn'+(g==='female'?' active':'');
    document.getElementById('btnM').className='gender-btn'+(g==='male'?' active':'');
    speak(g==='female'?'Main hun aapki female assistant!':'Main hun aapka male assistant!');
}

// ‚ïê‚ïê SPEAK ‚ïê‚ïê
function speak(text){
    if(!window.speechSynthesis)return;
    window.speechSynthesis.cancel();
    const clean=text.replace(/[^\x00-\x7F\u0900-\u097F\s]/g,'').replace(/\*\*/g,'').trim().substring(0,300);
    if(!clean)return;
    const u=new SpeechSynthesisUtterance(clean);
    u.lang='hi-IN'; u.rate=parseFloat(document.getElementById('spd').value);
    u.pitch=voiceGender==='female'?1.4:0.7; u.volume=1;
    const vs=window.speechSynthesis.getVoices();
    const hi=vs.filter(v=>v.lang.includes('hi')||v.lang.includes('IN'));
    if(hi.length) u.voice=voiceGender==='female'?(hi.find(v=>v.name.toLowerCase().includes('female'))||hi[0]):(hi.find(v=>v.name.toLowerCase().includes('male'))||hi[hi.length-1]);
    u.onstart=()=>document.getElementById('speakRow').classList.add('on');
    u.onend=()=>document.getElementById('speakRow').classList.remove('on');
    window.speechSynthesis.speak(u);
}
if(window.speechSynthesis)window.speechSynthesis.onvoiceschanged=()=>window.speechSynthesis.getVoices();

// ‚ïê‚ïê VOICE INPUT ‚ïê‚ïê
function initVoice(){
    const SR=window.SpeechRecognition||window.webkitSpeechRecognition;
    if(!SR){document.getElementById('voiceBtn').style.opacity='0.4';return;}
    recog=new SR(); recog.lang='hi-IN'; recog.continuous=false; recog.interimResults=true;
    recog.onstart=()=>{listening=true;document.getElementById('voiceBtn').classList.add('listening');document.getElementById('vStatus').textContent='üé§ Sun raha hoon...';bubble('Bol do! üëÇ');};
    recog.onresult=e=>{let t='';for(let i=e.resultIndex;i<e.results.length;i++)t+=e.results[i][0].transcript;document.getElementById('msgInput').value=t;document.getElementById('vStatus').textContent='üìù '+t;};
    recog.onend=()=>{listening=false;document.getElementById('voiceBtn').classList.remove('listening');document.getElementById('vStatus').textContent='';const v=document.getElementById('msgInput').value.trim();if(v&&fileReady)setTimeout(sendMsg,500);};
    recog.onerror=()=>{listening=false;document.getElementById('voiceBtn').classList.remove('listening');document.getElementById('vStatus').textContent='‚ö†Ô∏è Try again';setTimeout(()=>document.getElementById('vStatus').textContent='',2000);};
}
function toggleVoice(){if(!recog){alert('Chrome mein try karo!');return;}if(listening)recog.stop();else recog.start();}

// ‚ïê‚ïê INIT ‚ïê‚ïê
window.addEventListener('DOMContentLoaded',()=>{
    initMascot(); initVoice();
    fetch('/get_username').then(r=>r.json()).then(d=>{
        const name=d.username||'User'; plan=d.plan||'free';
        document.getElementById('wName').textContent=name.toUpperCase()+'! üëã';
        document.getElementById('wSub').textContent=plan==='pro'?'Pro Plan Active ‚≠ê':'‡§ï‡§π‡§æ‡§Å ‡§∏‡•á ‡§∂‡•Å‡§∞‡•Å‡§Ü‡§§ ‡§ï‡§∞‡•á‡§Ç?';
        document.getElementById('drawerName').textContent=name;
        document.getElementById('drawerSub').innerHTML=`${plan==='pro'?'Pro plan':'Free plan'} <span class="plan-pill ${plan}">${plan==='pro'?'‚≠ê Pro':'Free'}</span>`;
        document.getElementById('drawerAvatar').textContent=name.charAt(0).toUpperCase();
        document.getElementById('drawerPill').textContent=plan==='pro'?'‚≠ê Pro':'Free';
        document.getElementById('drawerPill').className='plan-pill '+plan;
        document.getElementById('topAvatar').textContent=name.charAt(0).toUpperCase();
        if(d.is_admin)document.getElementById('adminSection').style.display='block';
        if(plan==='free'){
            const qb=document.getElementById('queryBar'); qb.classList.add('show');
            const used=d.queries_used||0, lim=d.queries_limit||10;
            document.getElementById('qbText').textContent=`${used}/${lim} queries`;
            document.getElementById('qbFill').style.width=(used/lim*100)+'%';
        }
        setTimeout(()=>bubble('Namaste '+name+'! üòÑ'),2000);
    }).catch(()=>{
        document.getElementById('wName').textContent='USER! üëã';
        document.getElementById('drawerAvatar').textContent='U';
        document.getElementById('topAvatar').textContent='U';
    });
    fetch('/affiliate_links').then(r=>r.json()).then(d=>affiliates=d).catch(()=>{});
});

// ‚ïê‚ïê AI TOGGLE ‚ïê‚ïê
function toggleAI(cb){
    if(cb.checked&&plan!=='pro'){
        cb.checked=false;
        addMsg('‚≠ê AI Chat Mode sirf Pro plan mein!\n\nUpgrade karo: /pricing','bot');
        window.location.href='/pricing'; return;
    }
    aiMode=cb.checked;
    document.getElementById('aiBadge').className='ai-on-badge'+(aiMode?' on':'');
    document.getElementById('msgInput').placeholder=aiMode?'Seedha Hinglish mein puch lo...':"Type command or question...";
    addMsg(aiMode?'ü§ñ AI Chat Mode ON! Kuch bhi puch lo!':'‚ö° Command Mode ON!','bot');
    bubble(aiMode?'AI Mode ON! üß†':'Command Mode ‚ö°');
}

// ‚ïê‚ïê ADD MESSAGE ‚ïê‚ïê
function addMsg(text,sender){
    const area=document.getElementById('chatArea');
    const row=document.createElement('div');
    row.className='reaction-row'+(sender.includes('bot')?'':' user-row');

    if(sender.includes('bot')){
        const rx=getRx(text);
        const ch=document.createElement('span');
        ch.className='r-char'; ch.textContent=rx.e;
        // animate
        if(rx.a==='celebrate')ch.style.animation='bob 0.6s ease 3';
        if(rx.a==='shake'){ch.style.animation='shake 0.4s ease 3';}
        row.appendChild(ch);
        bubble(rx.e+' '+rx.l);
        setTimeout(()=>{if(aiMode&&text.length<200)speak(text);},300);
        history.push({t:'bot',text,ts:new Date().toLocaleString()});
    }else{history.push({t:'user',text,ts:new Date().toLocaleString()});}

    const bub=document.createElement('div');
    bub.className='r-bubble '+(sender.includes('bot')?(sender.includes('ai-mode')?'ai-mode':''):'user');
    bub.innerText=text;

    if(sender.includes('bot')){
        const acts=document.createElement('div');acts.className='r-actions';
        const d=document.createElement('button');d.className='r-action-btn';d.textContent='üíæ';d.onclick=()=>dlSingle(text);
        const s=document.createElement('button');s.className='r-action-btn';s.textContent='üîä';s.onclick=()=>speak(text);
        acts.appendChild(d);acts.appendChild(s);bub.appendChild(acts);
    }

    row.appendChild(bub);
    area.appendChild(row);
    area.scrollTop=area.scrollHeight;
}

function showTyping(){
    const area=document.getElementById('chatArea');
    const row=document.createElement('div');row.className='reaction-row';row.id='typingRow';
    const ch=document.createElement('span');ch.className='r-char';ch.textContent='ü§î';
    const bub=document.createElement('div');bub.className='r-bubble';
    bub.innerHTML='<div class="typing-dots"><span></span><span></span><span></span></div>';
    row.appendChild(ch);row.appendChild(bub);
    area.appendChild(row);area.scrollTop=area.scrollHeight;
    bubble('Soch raha hoon... ü§î');
}
function removeTyping(){const el=document.getElementById('typingRow');if(el)el.remove();}
function setInput(e){document.getElementById('msgInput').disabled=!e;document.getElementById('sendBtn').disabled=!e;}
function quickCmd(cmd){closeDrawer();document.getElementById('msgInput').value=cmd;sendMsg();}
function handleSessExp(){document.getElementById('sessOverlay').classList.add('show');}

// ‚ïê‚ïê UPLOAD ‚ïê‚ïê
function uploadFile(input){
    if(!input.files[0])return;
    const fd=new FormData();fd.append('file',input.files[0]);
    document.getElementById('uploadTxt').innerHTML='<div class="loader"></div> Syncing...';
    setInput(false);bubble('Upload ho rahi hai... ‚è≥');
    fetch('/upload',{method:'POST',body:fd})
    .then(r=>{if(r.status===401)return r.json().then(d=>{if(d.error==='SESSION_EXPIRED')handleSessExp();throw new Error('sess');});return r.json();})
    .then(d=>{
        addMsg('‚úÖ '+d.message,'bot');
        const z=document.getElementById('uploadZone');
        z.classList.add('synced');
        document.getElementById('uploadTxt').textContent='‚úÖ Synced: '+input.files[0].name;
        fileReady=true;setInput(true);
        document.getElementById('msgInput').placeholder='Kuch bhi puch lo...';
        bubble('File ready! Shuru karo! üéâ');
    })
    .catch(e=>{if(e.message==='sess')return;addMsg('‚ùå Upload failed!','bot');document.getElementById('uploadTxt').textContent='üìÅ Try Again';setInput(true);bubble('Upload fail üòÖ');});
}

// ‚ïê‚ïê SEND ‚ïê‚ïê
function sendMsg(){
    const inp=document.getElementById('msgInput');
    const msg=inp.value.trim();
    if(!msg||processing)return;
    if(!fileReady){addMsg('‚ö†Ô∏è Pehle file upload karo!','bot');return;}
    addMsg(msg,'user');inp.value='';processing=true;setInput(false);showTyping();
    fetch('/chat',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({message:msg,ai_mode:aiMode})})
    .then(r=>{if(r.status===401)return r.json().then(d=>{if(d.error==='SESSION_EXPIRED')handleSessExp();throw new Error('sess');});return r.json();})
    .then(d=>{
        removeTyping();
        addMsg(d.response,aiMode?'bot ai-mode':'bot');
        if(d.limit_reached)bubble('Query limit! Upgrade karo ‚≠ê');
        const ml=msg.toLowerCase();
        let showDl=false;
        if(['plot','chart','graph','bar','hist'].some(t=>ml.includes(t))||d.response.toLowerCase().includes('plot saved')){setTimeout(()=>{plotR=true;document.getElementById('dlPlot').disabled=false;showDl=true;showDlSection();},1500);}
        if(ml.includes('dashboard')){setTimeout(()=>{dashR=true;document.getElementById('dlDash').disabled=false;showDlSection();},2500);}
        if(['excel','xlsx'].some(t=>ml.includes(t))){setTimeout(()=>{excelR=true;document.getElementById('dlExcel').disabled=false;showDlSection();},1500);}
        if(ml.includes('csv')){setTimeout(()=>{csvR=true;document.getElementById('dlCSV').disabled=false;showDlSection();},1500);}
        if(ml.includes('html')){setTimeout(()=>{htmlR=true;document.getElementById('dlHTML').disabled=false;showDlSection();},1500);}
        processing=false;setInput(true);
    })
    .catch(e=>{if(e.message==='sess')return;removeTyping();addMsg('‚ö†Ô∏è Server slow hai.','bot');bubble('Connection issue üòÖ');processing=false;setInput(true);});
}

function showDlSection(){document.getElementById('dlSection').classList.add('show');}

// ‚ïê‚ïê AFFILIATE + DOWNLOAD ‚ïê‚ïê
function triggerDl(type){
    closePlus();
    if(affiliates.length){
        const link=affiliates[Math.floor(Math.random()*affiliates.length)];
        document.getElementById('affTitle').textContent=link.title;
        document.getElementById('affDesc').textContent=link.description||'Check out our partner!';
        document.getElementById('affLink').href=link.url;
        pendingDl=type;
        document.getElementById('affOverlay').classList.add('show');
    }else{doDl(type);}
}
function proceedDl(){document.getElementById('affOverlay').classList.remove('show');if(pendingDl){doDl(pendingDl);pendingDl=null;}}
function doDl(type){
    const m={
        plot:{r:plotR,url:'/plot.png',name:'plot_'+Date.now()+'.png',msg:'Pehle chart banao!'},
        dashboard:{r:dashR,url:'/dashboard.png',name:'dashboard_'+Date.now()+'.png',msg:'Pehle dashboard banao!'},
        excel:{r:excelR,url:'/download/excel',name:'report_'+Date.now()+'.xlsx',msg:'"export excel" command do!'},
        csv:{r:csvR,url:'/download/csv',name:'data_'+Date.now()+'.csv',msg:'"export csv" command do!'},
        html:{r:htmlR,url:'/download/html',name:'report_'+Date.now()+'.html',msg:'"export html" command do!'}
    };
    const item=m[type];if(!item)return;
    if(!item.r){alert(item.msg);return;}
    const a=document.createElement('a');a.href=item.url+'?t='+Date.now();a.download=item.name;document.body.appendChild(a);a.click();document.body.removeChild(a);
}
function dlSingle(text){const blob=new Blob([text],{type:'text/plain'});const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download='response_'+Date.now()+'.txt';document.body.appendChild(a);a.click();document.body.removeChild(a);URL.revokeObjectURL(url);}
function dlAllReports(){if(!history.length){alert('No history!');return;}let c='ü§ñ DS Agent Report\n'+'='.repeat(40)+'\n'+new Date().toLocaleString()+'\n\n';history.forEach(m=>{c+=`[${m.ts}] ${m.t==='user'?'üë§ You':'ü§ñ Bot'}:\n${m.text}\n\n`+'-'.repeat(40)+'\n\n';});const blob=new Blob([c],{type:'text/plain'});const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download='report_'+Date.now()+'.txt';document.body.appendChild(a);a.click();document.body.removeChild(a);URL.revokeObjectURL(url);}

function sendReport(){const email=document.getElementById('emailInput').value;if(!email){alert('Email enter karo');return;}fetch('/send_report',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({email})}).then(r=>r.json()).then(d=>{alert(d.message||d.error);if(d.message)document.getElementById('emailModal').classList.remove('show');}).catch(()=>alert('Error'));}

function closeViewer(){document.getElementById('viewerModal').classList.remove('show');document.getElementById('viewerBox').innerHTML='';}
document.getElementById('viewerModal').addEventListener('click',e=>{if(e.target===document.getElementById('viewerModal'))closeViewer();});
document.getElementById('msgInput').addEventListener('keypress',e=>{if(e.key==='Enter'&&!e.target.disabled)sendMsg();});
</script>
</body>
</html>

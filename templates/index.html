<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ü§ñ DS Agent Master</title>
    <style>
        * { margin:0; padding:0; box-sizing:border-box }
        body { font-family: 'Segoe UI', Arial, sans-serif; background:#f0f2f5; padding:15px }
        .container { max-width:850px; margin:0 auto; background:white; border-radius:20px; box-shadow:0 10px 30px rgba(0,0,0,0.15); overflow:hidden; min-height: 90vh; display: flex; flex-direction: column; }
        
        .header { background:linear-gradient(135deg,#667eea,#764ba2); color:white; padding:25px; text-align:center; position: relative; }
        .status-dot { position: absolute; top: 15px; right: 20px; font-size: 12px; display: flex; align-items: center; gap: 5px; }
        .dot { height: 8px; width: 8px; background-color: #2ecc71; border-radius: 50%; display: inline-block; animation: pulse 2s infinite; }
        
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.4; } 100% { opacity: 1; } }

        .upload-box { border:2px dashed #667eea; border-radius:15px; padding:25px; text-align:center; margin:15px; cursor:pointer; background: #f8faff; transition: 0.3s; }
        .upload-box:hover { background: #edf2ff; border-style: solid; }
        
        .chat-box { flex-grow: 1; height:450px; overflow-y:auto; padding:20px; margin:0 15px; background:#ffffff; border: 1px solid #eee; border-radius: 12px; }
        .message { margin-bottom:15px; padding:12px 18px; border-radius:15px; max-width:85%; line-height: 1.5; font-size: 14px; }
        .user { background:#667eea; color:white; margin-left:auto; border-bottom-right-radius: 2px; }
        .bot { background:#f1f3f4; color:#333; border-bottom-left-radius: 2px; border: 1px solid #e0e0e0; }
        
        .input-area { display:flex; gap:10px; padding:20px; background: white; }
        .input-area input { flex:1; padding:14px 20px; border:1px solid #dfe1e5; border-radius:30px; outline: none; transition: 0.3s; }
        .input-area button { background:#667eea; color:white; border:none; padding:12px 28px; border-radius:30px; cursor:pointer; font-weight: bold; }
        
        /* üõ†Ô∏è Download Section: Shuruat mein hidden rahega */
        #plotSection { padding: 15px; margin: 15px; background: #fff; border-radius: 12px; border: 1px solid #eee; display: none; text-align: center; }
        #plotImg { max-width:100%; border-radius:8px; border: 1px solid #ddd; margin-bottom: 10px; }
        .dl-btn { width:100%; padding:12px; background:#ff6b6b; color:white; border:none; border-radius:8px; cursor:pointer; font-weight: bold; transition: 0.3s; }
        .dl-btn:hover { background: #ee5253; }
        
        .loader { border: 3px solid #f3f3f3; border-top: 3px solid #667eea; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; display: inline-block; vertical-align: middle; margin-right: 10px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="status-dot"><span class="dot"></span> Agent Live (v1.1)</div>
            <h1>ü§ñ Data Scientist Agent</h1>
            <p>Master Level AI Analysis & SQL Logging</p>
        </div>
        
        <div class="upload-box" id="dropZone" onclick="document.getElementById('fileInput').click()">
            <p id="uploadText">üìÅ Click to upload CSV/Excel to Database</p>
            <input type="file" id="fileInput" accept=".csv,.xlsx" style="display:none" onchange="uploadFile(this)">
        </div>
        
        <div class="chat-box" id="chatBox">
            <div class="message bot">üëã Master Mode Active! Upload data and let's find insights. Your queries are being securely logged.</div>
        </div>
        
        <div id="plotSection">
            <h4 style="margin-bottom:10px; color:#555; font-size:13px; text-align: left;">Latest Visualization:</h4>
            <img id="plotImg" src="">
            <a id="downloadLink" href="/plot.png" download="analysis_report.png">
                <button class="dl-btn">üíæ Download High-Res Plot</button>
            </a>
        </div>
        
        <div class="input-area">
            <input type="text" id="userInput" placeholder="Ask about trends, predictions, or charts...">
            <button onclick="sendMessage()">Send</button>
        </div>
    </div>

    <script>
        let isFileReady = false;

        function addMessage(text, sender) {
            const chatBox = document.getElementById('chatBox');
            const msgDiv = document.createElement('div');
            msgDiv.className = 'message ' + sender;
            msgDiv.innerText = text;
            chatBox.appendChild(msgDiv);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        function uploadFile(input) {
            if(!input.files[0]) return;
            const formData = new FormData();
            formData.append('file', input.files[0]);
            
            document.getElementById('uploadText').innerHTML = '<div class="loader"></div> Syncing with DB...';
            
            fetch('/upload', { method: 'POST', body: formData })
            .then(res => res.json())
            .then(data => { 
                addMessage("‚úÖ " + data.message, 'bot'); 
                document.getElementById('uploadText').innerText = "üìÅ File Synced: " + input.files[0].name;
                isFileReady = true; 
            })
            .catch(err => {
                addMessage("‚ùå Connection Error", 'bot');
                document.getElementById('uploadText').innerText = "üìÅ Try Again";
            });
        }

        function sendMessage() {
            const input = document.getElementById('userInput');
            const msg = input.value.trim();
            if(!msg) return;
            if(!isFileReady) {
                addMessage("‚ö†Ô∏è Bhai, pehle file upload toh kar lo!", "bot");
                return;
            }

            addMessage(msg, 'user');
            input.value = '';

            fetch('/chat', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({message: msg})
            })
            .then(res => res.json())
            .then(data => {
                addMessage(data.response, 'bot');
                
                // üîç Trigger plot visibility only when needed
                const plotTriggers = ['plot', 'chart', 'graph', 'visualize', 'bar', 'hist'];
                if(plotTriggers.some(t => msg.toLowerCase().includes(t)) || data.response.toLowerCase().includes("plot saved")) {
                    setTimeout(refreshPlot, 1000);
                }
            })
            .catch(err => addMessage("‚ö†Ô∏è Server slow hai, thoda wait kijiye.", 'bot'));
        }

        function refreshPlot() {
            const img = document.getElementById('plotImg');
            const section = document.getElementById('plotSection');
            
            // Generate unique URL to bypass browser cache
            const newSrc = "/plot.png?t=" + new Date().getTime();
            img.src = newSrc;
            document.getElementById('downloadLink').href = newSrc;

            img.onload = function() {
                section.style.display = "block"; // ‚úÖ AB BUTTON SHOW HOGA
                document.getElementById('chatBox').scrollTop = document.getElementById('chatBox').scrollHeight;
            };
        }
    </script>
</body>
</html>

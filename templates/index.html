<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ü§ñ Data Scientist Agent</title>
    <style>
        * { margin:0; padding:0; box-sizing:border-box }
        body { font-family:Arial,sans-serif; background:#f5f7fa; padding:15px }
        .container { max-width:800px; margin:0 auto; background:white; border-radius:15px; box-shadow:0 5px 25px rgba(0,0,0,0.1); overflow:hidden; min-height: 100vh; display: flex; flex-direction: column; }
        .header { background:linear-gradient(135deg,#667eea,#764ba2); color:white; padding:20px; text-align:center }
        .upload-box { border:2px dashed #667eea; border-radius:12px; padding:20px; text-align:center; margin:15px; cursor:pointer }
        .chat-box { flex-grow: 1; height:400px; overflow-y:auto; padding:15px; margin:0 15px 15px; background:#f8f9fa; border-radius:12px; border: 1px solid #eee; }
        .message { margin-bottom:12px; padding:10px 15px; border-radius:18px; max-width:85%; word-wrap: break-word; }
        .user { background:#667eea; color:white; margin-left:auto }
        .bot { background:#e9ecef; color:#333 }
        .input-area { display:flex; gap:10px; padding:15px }
        .input-area input { flex:1; padding:12px 15px; border:1px solid #ddd; border-radius:25px }
        .input-area button { background:#667eea; color:white; border:none; padding:12px 25px; border-radius:25px; cursor:pointer }
        #plotImg { max-width:100%; border-radius:10px; margin-top: 10px; display: none; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ü§ñ Data Scientist Agent</h1>
            <p>Powered by Groq Llama 3.3</p>
        </div>
        
        <div class="upload-box" onclick="document.getElementById('fileInput').click()">
            <p>üìÅ Click to upload CSV/Excel</p>
            <input type="file" id="fileInput" accept=".csv,.xlsx" onchange="uploadFile(this)">
        </div>
        
        <div class="chat-box" id="chatBox">
            <div class="message bot">üëã Ready! Upload file and ask me anything.</div>
        </div>
        
        <div class="input-area">
            <input type="text" id="userInput" placeholder="Type command...">
            <button onclick="sendMessage()">Send</button>
        </div>

        <!-- Plot Section -->
        <div style="padding: 15px; text-align: center;">
            <img id="plotImg" src="">
            <p id="plotStatus" style="font-size: 12px; color: #999;"></p>
            
            <!-- üíæ DOWNLOAD BUTTON -->
            <a href="/static/plot.png" download="data-analysis-report.png">
                <button style="
                    background-color: #ff6b6b;
                    color: white;
                    border: none;
                    padding: 10px 20px;
                    margin-top: 10px;
                    border-radius: 8px;
                    cursor: pointer;
                    font-size: 14px;
                    width: 100%;
                    transition: background-color 0.3s;
                " onmouseover="this.style.backgroundColor='#ee5253'"
                   onmouseout="this.style.backgroundColor='#ff6b6b'">
                    üíæ Download Report
                </button>
            </a>
        </div>
    </div>

    <script>
        let uploaded = false;

        function addMessage(text, sender) {
            const chatBox = document.getElementById('chatBox');
            const msgDiv = document.createElement('div');
            msgDiv.className = 'message ' + sender;
            msgDiv.innerText = text;
            chatBox.appendChild(msgDiv);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        function uploadFile(input) {
            const formData = new FormData();
            formData.append('file', input.files[0]);
            addMessage("‚è≥ Uploading...", "bot");
            fetch('/upload', { method: 'POST', body: formData })
            .then(res => res.json())
            .then(data => { 
                addMessage(data.message, 'bot'); 
                uploaded = true; 
            })
            .catch(err => addMessage("‚ùå Upload Error", 'bot'));
        }

        function sendMessage() {
            const input = document.getElementById('userInput');
            const msg = input.value;
            if(!msg || !uploaded) return;
            addMessage(msg, 'user');
            input.value = '';

            fetch('/chat', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({message: msg})
            })
            .then(res => res.json())
            .then(data => {
                addMessage(data.response, 'bot');
                if(data.response.toLowerCase().includes("plot")) refreshPlot();
            })
            .catch(err => addMessage("‚ö†Ô∏è Server is slow, try a simpler command.", 'bot'));
        }

        // Refresh plot image
        function refreshPlot() {
            const img = document.getElementById('plotImg');
            img.src = "/static/plot.png?t=" + new Date().getTime();
            img.style.display = "block";
        }
    </script>
</body>
</html>
